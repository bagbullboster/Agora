<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Agora</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@400;500;600;700;800;900&family=Barlow+Condensed:wght@400;600;700;800&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
/* =======================================
   AGORA v4 - styles.css
======================================= */
:root {
  --bg:  #08090f;
  --bg2: #0e1018;
  --bg3: #141720;
  --bg4: #1a1e2a;
  --line:  rgba(255,255,255,0.06);
  --line2: rgba(255,255,255,0.11);
  --text:  #eef0ff;
  --text2: #7c82a0;
  --text3: #3d4160;
  --accent:  #5865f2;
  --accent2: #7983ff;
  --glow:    rgba(88,101,242,0.16);
  --green: #00e5a0;
  --red:   #ff3d6b;
  --gold:  #ffbe3d;
  --nav-h: 68px;
  --ff: 'Outfit', sans-serif;
  --fm: 'Space Mono', monospace;
}

/* LIGHT THEMES */
body.theme-white {
  --bg: #f8f9fc; --bg2: #ffffff; --bg3: #f0f2f8; --bg4: #e8ebf5;
  --line: rgba(0,0,0,0.07); --line2: rgba(0,0,0,0.12);
  --text: #0a0c18; --text2: #5a6080; --text3: #9aa0be;
}
body.theme-cream {
  --bg: #f5f0e8; --bg2: #faf7f2; --bg3: #ede8df; --bg4: #e4ddd2;
  --line: rgba(0,0,0,0.07); --line2: rgba(0,0,0,0.12);
  --text: #1a1510; --text2: #6b6050; --text3: #a09080;
}
body.theme-navy {
  --bg: #020818; --bg2: #05102a; --bg3: #081540; --bg4: #0d1f52;
}

/* FONT THEMES */
body.font-sharp   { --ff: 'Barlow Condensed', sans-serif; }
body.font-elegant { --ff: 'DM Serif Display', serif; }

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { scroll-behavior:smooth; }
body {
  font-family: var(--ff);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  padding-bottom: calc(var(--nav-h) + 6px);
  transition: background 0.3s, color 0.3s;
}
::-webkit-scrollbar { width:0; height:0; }

/* HEADER */
.hdr {
  position: sticky; top:0; z-index:600;
  background: rgba(8,9,15,0.92);
  backdrop-filter: blur(28px); -webkit-backdrop-filter: blur(28px);
  border-bottom: 1px solid var(--line);
  transition: background 0.3s;
}
body.theme-white .hdr, body.theme-cream .hdr { background: rgba(248,249,252,0.94); }
.hdr-top { display:flex; align-items:center; gap:10px; padding:13px 16px 10px; }
.logo {
  font-size:17px; font-weight:900; letter-spacing:-0.5px;
  background: linear-gradient(135deg, var(--text) 0%, var(--accent2) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  flex-shrink:0; cursor:pointer;
}
.srch { flex:1; position:relative; }
.srch input {
  width:100%; background:var(--bg3); border:1px solid var(--line2);
  border-radius:11px; padding:9px 13px 9px 36px;
  color:var(--text); font-family:var(--ff); font-size:14px; outline:none;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.srch input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); }
.srch input::placeholder { color:var(--text3); }
.srch-ic { position:absolute; left:11px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:13px; pointer-events:none; }
.hbtns { display:flex; gap:7px; flex-shrink:0; }
.hbtn {
  width:36px; height:36px; border-radius:10px;
  background:var(--bg3); border:1px solid var(--line2);
  color:var(--text2); display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:14px; transition:all 0.2s; flex-shrink:0;
}
.hbtn:active { transform:scale(0.92); }
.hbtn.on { background:var(--accent); border-color:var(--accent); color:#fff; box-shadow:0 0 12px var(--glow); }

/* TOOL BAR */
.tool-bar { padding:0 16px 10px; display:none; }
.tool-bar.visible { display:block; }
.tab-pills { display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px; }
.tpill {
  flex-shrink:0; display:flex; align-items:center; gap:5px;
  padding:6px 13px; border-radius:20px; font-size:12px; font-weight:600;
  cursor:pointer; border:1px solid var(--line2); background:transparent;
  color:var(--text2); transition:all 0.2s; user-select:none;
}
.tpill.active { background:var(--accent); border-color:var(--accent); color:#fff; box-shadow:0 0 12px var(--glow); }
.tpill-arrow { font-size:9px; transition:transform 0.2s; }
.tpill.open .tpill-arrow { transform:rotate(180deg); }
.tool-panel {
  margin-top:8px; background:var(--bg2); border:1px solid var(--line2);
  border-radius:16px; overflow:hidden; display:none; animation:panelIn 0.18s ease;
}
.tool-panel.open { display:block; }
@keyframes panelIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
.tool-panel-title { padding:10px 14px 6px; font-size:10px; font-weight:700; letter-spacing:1.5px; color:var(--text3); text-transform:uppercase; border-bottom:1px solid var(--line); }
.tool-grid { display:grid; grid-template-columns:1fr 1fr; gap:1px; background:var(--line); }
.tool-item { display:flex; align-items:center; gap:10px; padding:12px 14px; background:var(--bg2); cursor:pointer; transition:background 0.15s; user-select:none; }
.tool-item:active { background:var(--bg3); }
.tool-ic { font-size:16px; flex-shrink:0; }
.tool-name { font-size:12px; font-weight:600; flex:1; }
.tool-chk { width:20px; height:20px; border-radius:6px; border:1.5px solid var(--line2); display:flex; align-items:center; justify-content:center; font-size:11px; flex-shrink:0; transition:all 0.2s; }
.tool-item.on .tool-chk { background:var(--accent); border-color:var(--accent); color:#fff; }

/* CTX BAR */
.ctx-bar { padding:0 16px 10px; display:none; }
.ctx-bar.visible { display:block; }
.ctx-pills { display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px; }
.cpill { flex-shrink:0; padding:6px 13px; border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; border:1px solid var(--line2); background:transparent; color:var(--text2); transition:all 0.2s; }
.cpill.active { background:var(--accent); border-color:var(--accent); color:#fff; }

/* PAGES */
.page { display:none; }
.page.active { display:block; animation:pin 0.2s ease; }
@keyframes pin { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

/* SWIPEABLE HOME */
.home-pages-wrap { position:relative; overflow:hidden; touch-action:pan-y; }
.home-pages { display:flex; transition:transform 0.35s cubic-bezier(0.25,0.46,0.45,0.94); }
.home-page { flex-shrink:0; width:100%; padding:16px; }
.page-dots { display:flex; justify-content:center; gap:6px; padding:8px 0 12px; }
.pdot { width:6px; height:6px; border-radius:50%; background:var(--line2); transition:all 0.2s; }
.pdot.active { background:var(--accent); width:18px; border-radius:3px; }

/* LIVE BAR */
.live-bar { display:flex; align-items:center; gap:8px; padding:9px 13px; background:var(--bg2); border:1px solid var(--line); border-radius:11px; margin-bottom:18px; overflow:hidden; }
.ldot { width:6px; height:6px; border-radius:50%; background:var(--green); flex-shrink:0; animation:ldot 2s infinite; }
@keyframes ldot { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,229,160,0.4);}50%{opacity:.8;box-shadow:0 0 0 4px rgba(0,229,160,0);} }
.ltxt { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; transition:opacity 0.3s; }
.ltxt strong { color:var(--text); }

/* SECTIONS */
.sh { display:flex; align-items:center; justify-content:space-between; margin-bottom:13px; }
.st { font-size:15px; font-weight:800; display:flex; align-items:center; gap:6px; letter-spacing:-.2px; }
.sm { font-size:12px; color:var(--accent2); cursor:pointer; }
.sb { margin-bottom:22px; }

/* COMMUNITY CARD */
.cc { background:var(--bg2); border:1px solid var(--line); border-radius:20px; margin-bottom:13px; overflow:hidden; cursor:pointer; transition:border-color 0.2s, transform 0.15s; }
.cc:active { transform:scale(0.99); }
.cc:hover { border-color:var(--line2); }
.cc-banner { height:68px; position:relative; overflow:hidden; }
.cc-banner-bg { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:52px; opacity:.2; }
.cc-banner-fade { position:absolute; inset:0; background:linear-gradient(to bottom,transparent 0%,var(--bg2) 100%); }
.cc-body { padding:0 15px 15px; margin-top:-14px; position:relative; }
.cc-top { display:flex; align-items:flex-end; gap:11px; margin-bottom:10px; }
.cc-avi { width:50px; height:50px; border-radius:13px; border:3px solid var(--bg2); display:flex; align-items:center; justify-content:center; font-size:24px; flex-shrink:0; z-index:1; position:relative; }
.cc-meta { flex:1; padding-bottom:2px; }
.cc-name { font-size:15px; font-weight:800; margin-bottom:3px; display:flex; align-items:center; gap:5px; }
.cc-stats { display:flex; gap:9px; font-size:11px; color:var(--text2); }
.cc-price { text-align:right; padding-bottom:2px; }
.ccpv { font-family:var(--fm); font-size:12px; font-weight:700; margin-bottom:2px; }
.ccpc { font-size:11px; font-weight:700; }
.cc-latest { font-size:12px; color:var(--text2); line-height:1.5; padding:9px 11px; background:var(--bg3); border-radius:9px; border:1px solid var(--line); margin-bottom:9px; }
.cc-latest strong { color:var(--text); }
.cc-foot { display:flex; justify-content:space-between; align-items:center; }
.cc-actions { display:flex; gap:6px; }
.ca { padding:6px 13px; border-radius:18px; font-size:12px; font-weight:600; border:none; cursor:pointer; transition:all 0.2s; font-family:var(--ff); }
.ca.p { background:var(--accent); color:#fff; }
.ca.s { background:var(--bg4); color:var(--text2); border:1px solid var(--line2); }

/* TIER TAGS ‚Äî light-mode aware */
.tt { font-size:9px; font-weight:700; padding:2px 7px; border-radius:5px; letter-spacing:.5px; }
.tt.safe      { background:rgba(0,229,160,.18);  color:#00b87a; }
.tt.community { background:rgba(255,190,61,.18);  color:#c98a00; }
.tt.degen     { background:rgba(255,61,107,.18);  color:#d42050; }
body.theme-white .tt.safe, body.theme-cream .tt.safe      { background:rgba(0,160,100,.12); color:#007a50; }
body.theme-white .tt.community, body.theme-cream .tt.community { background:rgba(200,140,0,.12); color:#8a5c00; }
body.theme-white .tt.degen, body.theme-cream .tt.degen    { background:rgba(200,30,70,.12);  color:#a0001e; }

/* TWEET CARD */
.twc { background:var(--bg2); border:1px solid var(--line); border-radius:17px; padding:15px; margin-bottom:11px; cursor:pointer; transition:border-color 0.2s; }
.twc:hover { border-color:var(--line2); }
.twc-hd { display:flex; gap:9px; margin-bottom:9px; align-items:center; }
.twc-avi { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:800; flex-shrink:0; }
.twc-auth { font-size:13px; font-weight:700; }
.twc-time { font-size:11px; color:var(--text3); }
.twc-txt { font-size:14px; line-height:1.5; margin-bottom:11px; }
.twc-chips { display:flex; gap:7px; overflow-x:auto; -webkit-overflow-scrolling:touch; margin-bottom:9px; }
.twc-chip { flex-shrink:0; padding:7px 11px; border-radius:11px; border:1px solid; min-width:105px; }
.twc-chip.safe      { border-color:rgba(0,229,160,.3); background:rgba(0,229,160,.06); }
.twc-chip.community { border-color:rgba(255,190,61,.3); background:rgba(255,190,61,.06); }
.twc-chip.degen     { border-color:rgba(255,61,107,.3); background:rgba(255,61,107,.06); }
.twc-chip-sym { font-weight:800; font-size:12px; margin-bottom:2px; }
.twc-chip-inf { font-size:10px; color:var(--text2); }
.twc-foot { display:flex; gap:11px; font-size:11px; color:var(--text3); }

/* TOKEN ROW */
.tr { display:flex; align-items:center; gap:11px; padding:11px 13px; background:var(--bg2); border:1px solid var(--line); border-radius:13px; margin-bottom:6px; cursor:pointer; transition:all 0.15s; }
.tr:hover { background:var(--bg3); border-color:var(--line2); }
.tr:active { transform:scale(0.99); }
.t-logo { width:38px; height:38px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:19px; flex-shrink:0; }
.t-inf { flex:1; min-width:0; }
.t-name { font-size:13px; font-weight:700; margin-bottom:2px; display:flex; align-items:center; gap:5px; }
.t-sub { font-size:10px; color:var(--text3); display:flex; align-items:center; gap:4px; }
.tdot { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
.tdot.safe      { background:var(--green); }
.tdot.community { background:var(--gold); }
.tdot.degen     { background:var(--red); }
.t-spark { width:54px; flex-shrink:0; }
.t-price { text-align:right; flex-shrink:0; }
.t-pv { font-family:var(--fm); font-size:11px; font-weight:700; margin-bottom:1px; }
.t-pc { font-size:11px; font-weight:700; }
.pos { color:var(--green); }
.neg { color:var(--red); }

/* DISCOVER */
.frow { display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; margin-bottom:15px; padding:16px 16px 2px; }
.fc { flex-shrink:0; padding:6px 13px; border-radius:18px; font-size:12px; font-weight:600; cursor:pointer; border:1px solid var(--line2); background:transparent; color:var(--text2); transition:all 0.2s; font-family:var(--ff); }
.fc.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.discover-list { padding:0 16px 16px; }

/* TRENCHES */
.trenches-page { padding:0; }
.trench-filters { display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:14px 16px 10px; }
.tf { flex-shrink:0; padding:6px 12px; border-radius:18px; font-size:11px; font-weight:600; cursor:pointer; border:1px solid var(--line2); background:transparent; color:var(--text2); transition:all 0.2s; font-family:var(--ff); }
.tf.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.tf.age-active { background:var(--gold); border-color:var(--gold); color:#000; }
.tf.src-dex    { background:rgba(88,101,242,.15); border-color:rgba(88,101,242,.4); color:var(--accent2); }
.tf.src-agora  { background:rgba(0,229,160,.15); border-color:rgba(0,229,160,.4); color:var(--green); }
.tf.src-organic{ background:rgba(255,190,61,.15); border-color:rgba(255,190,61,.4); color:var(--gold); }
.trench-divider { padding:4px 16px 6px; font-size:10px; font-weight:700; letter-spacing:1.5px; color:var(--text3); text-transform:uppercase; }
.trench-list { padding:0 16px 16px; }
.trench-row { display:flex; align-items:center; gap:11px; padding:11px 13px; background:var(--bg2); border:1px solid var(--line); border-radius:13px; margin-bottom:6px; cursor:pointer; transition:all 0.15s; position:relative; overflow:hidden; }
.trench-row:active { transform:scale(0.99); }
.trench-row::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; }
.trench-row.src-dex::before    { background:var(--accent); }
.trench-row.src-agora::before  { background:var(--green); }
.trench-row.src-organic::before{ background:var(--gold); }
.trench-age { font-family:var(--fm); font-size:9px; color:var(--text3); white-space:nowrap; }
.trench-src { font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px; white-space:nowrap; }
.trench-src.src-dex    { background:rgba(88,101,242,.15); color:var(--accent2); }
.trench-src.src-agora  { background:rgba(0,229,160,.15); color:var(--green); }
.trench-src.src-organic{ background:rgba(255,190,61,.15); color:var(--gold); }

/* CHARTS TAB */
.charts-page { display:flex; flex-direction:column; height:calc(100vh - var(--nav-h) - 52px); }
.chart-tabs-bar { display:flex; align-items:center; gap:0; overflow-x:auto; -webkit-overflow-scrolling:touch; background:var(--bg2); border-bottom:1px solid var(--line); padding:0 8px; flex-shrink:0; }
.chart-tab { flex-shrink:0; display:flex; align-items:center; gap:6px; padding:10px 12px; font-size:12px; font-weight:600; color:var(--text2); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; white-space:nowrap; }
.chart-tab.active { color:var(--text); border-bottom-color:var(--accent); }
.chart-tab-close { width:14px; height:14px; border-radius:50%; background:var(--bg4); display:flex; align-items:center; justify-content:center; font-size:9px; color:var(--text3); transition:all 0.15s; }
.chart-tab-close:hover { background:var(--red); color:#fff; }
.chart-tab-add { flex-shrink:0; width:32px; height:32px; border-radius:9px; background:var(--bg3); border:1px solid var(--line2); display:flex; align-items:center; justify-content:center; font-size:16px; cursor:pointer; color:var(--text2); margin-left:4px; transition:all 0.2s; }
.chart-tab-add:active { transform:scale(0.92); }
.chart-frame { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.chart-symbol-bar { display:flex; align-items:center; gap:10px; padding:10px 16px; background:var(--bg2); border-bottom:1px solid var(--line); flex-shrink:0; }
.chart-sym { font-size:16px; font-weight:900; }
.chart-price { font-family:var(--fm); font-size:14px; font-weight:700; }
.chart-change { font-size:12px; font-weight:700; }
.chart-pip-btn { margin-left:auto; padding:6px 12px; background:var(--accent); border:none; border-radius:9px; color:#fff; font-family:var(--ff); font-size:11px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px; }
.chart-area { flex:1; background:var(--bg); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
.chart-placeholder { text-align:center; color:var(--text3); }
.chart-placeholder-ic { font-size:40px; margin-bottom:10px; }
.chart-placeholder p { font-size:13px; }
.chart-timeframes { display:flex; gap:4px; padding:8px 16px; background:var(--bg2); border-top:1px solid var(--line); flex-shrink:0; }
.chart-tf { padding:5px 10px; border-radius:7px; font-size:11px; font-weight:600; color:var(--text2); cursor:pointer; transition:all 0.15s; font-family:var(--fm); }
.chart-tf.active { background:var(--accent); color:#fff; }
.chart-tools { display:flex; gap:6px; padding:0 16px 8px; background:var(--bg2); flex-shrink:0; overflow-x:auto; }
.chart-tool-btn { flex-shrink:0; padding:7px 11px; background:var(--bg3); border:1px solid var(--line2); border-radius:9px; font-size:11px; color:var(--text2); cursor:pointer; transition:all 0.15s; font-family:var(--ff); }
.chart-tool-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.chart-trade-bar { display:flex; gap:8px; padding:10px 16px; background:var(--bg2); border-top:1px solid var(--line); flex-shrink:0; }
.chart-buy { flex:1; padding:11px; background:var(--green); border:none; border-radius:12px; color:#000; font-family:var(--ff); font-size:13px; font-weight:800; cursor:pointer; transition:opacity 0.2s; }
.chart-sell { flex:1; padding:11px; background:var(--red); border:none; border-radius:12px; color:#fff; font-family:var(--ff); font-size:13px; font-weight:800; cursor:pointer; transition:opacity 0.2s; }
.chart-limit { padding:11px 14px; background:var(--bg3); border:1px solid var(--line2); border-radius:12px; color:var(--text2); font-family:var(--ff); font-size:12px; font-weight:600; cursor:pointer; white-space:nowrap; }
.chart-buy:active, .chart-sell:active, .chart-limit:active { opacity:0.8; }
.chart-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; padding:40px; text-align:center; color:var(--text3); gap:12px; }
.chart-empty-ic { font-size:44px; }
.chart-empty h3 { font-size:16px; font-weight:700; color:var(--text2); }
.chart-empty p { font-size:13px; line-height:1.5; }
.chart-empty-btn { padding:10px 20px; background:var(--accent); border:none; border-radius:12px; color:#fff; font-family:var(--ff); font-size:13px; font-weight:700; cursor:pointer; }

/* SWAP TAB */
.swap-page { padding:16px; }
.swap-card { background:var(--bg2); border:1px solid var(--line2); border-radius:20px; padding:18px; margin-bottom:14px; }
.swap-label { font-size:11px; font-weight:700; letter-spacing:1px; color:var(--text3); text-transform:uppercase; margin-bottom:10px; }
.swap-token-row { display:flex; align-items:center; gap:10px; }
.swap-token-sel { display:flex; align-items:center; gap:7px; padding:8px 12px; background:var(--bg3); border:1px solid var(--line2); border-radius:12px; cursor:pointer; transition:all 0.2s; flex-shrink:0; }
.swap-token-sel:active { transform:scale(0.97); }
.swap-token-ic { font-size:18px; }
.swap-token-sym { font-size:14px; font-weight:800; }
.swap-token-arr { font-size:10px; color:var(--text3); }
.swap-amount { flex:1; background:transparent; border:none; outline:none; font-family:var(--fm); font-size:22px; font-weight:700; color:var(--text); text-align:right; }
.swap-amount::placeholder { color:var(--text3); }
.swap-usd { text-align:right; font-size:11px; color:var(--text3); margin-top:4px; font-family:var(--fm); }
.swap-flip { width:44px; height:44px; border-radius:13px; background:var(--bg3); border:1px solid var(--line2); display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; margin:0 auto; transition:all 0.2s; }
.swap-flip:active { transform:rotate(180deg) scale(0.92); }
.swap-info { background:var(--bg2); border:1px solid var(--line); border-radius:14px; padding:13px 15px; margin-bottom:16px; }
.swap-info-row { display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--text2); margin-bottom:6px; }
.swap-info-row:last-child { margin-bottom:0; }
.swap-info-val { font-family:var(--fm); color:var(--text); font-weight:600; }
.swap-btn { width:100%; padding:15px; background:var(--accent); border:none; border-radius:16px; color:#fff; font-family:var(--ff); font-size:16px; font-weight:800; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 20px var(--glow); }
.swap-btn:active { transform:scale(0.98); opacity:0.9; }
.swap-btn:disabled { background:var(--bg4); color:var(--text3); box-shadow:none; cursor:default; }
.swap-slippage { display:flex; gap:6px; margin-bottom:14px; }
.slip-opt { flex:1; padding:8px; background:var(--bg2); border:1px solid var(--line); border-radius:10px; text-align:center; font-size:11px; font-weight:700; color:var(--text2); cursor:pointer; transition:all 0.2s; font-family:var(--fm); }
.slip-opt.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.swap-section-title { font-size:13px; font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:6px; }

/* COMMS */
.comms-page { padding:0; }
.chat-list { padding:0 16px 16px; }
.chat-item { display:flex; gap:12px; padding:13px 14px; background:var(--bg2); border:1px solid var(--line); border-radius:14px; margin-bottom:7px; cursor:pointer; transition:border-color 0.2s; position:relative; }
.chat-item:hover { border-color:var(--line2); }
.chat-item.unread { border-left:3px solid var(--accent); }
.chat-avi { width:44px; height:44px; border-radius:13px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; position:relative; }
.chat-online { position:absolute; bottom:1px; right:1px; width:10px; height:10px; border-radius:50%; background:var(--green); border:2px solid var(--bg2); }
.chat-info { flex:1; min-width:0; }
.chat-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; }
.chat-name { font-size:13px; font-weight:700; }
.chat-time { font-size:10px; color:var(--text3); }
.chat-preview { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:3px; }
.chat-meta { display:flex; gap:6px; align-items:center; }
.chat-badge { font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px; }
.chat-unread-count { min-width:18px; height:18px; border-radius:9px; background:var(--accent); color:#fff; font-size:10px; font-weight:700; display:flex; align-items:center; justify-content:center; padding:0 4px; margin-left:auto; }
.oracle-card { margin:0 16px 16px; background:linear-gradient(135deg,var(--bg3) 0%,rgba(88,101,242,0.12) 100%); border:1px solid var(--line2); border-radius:18px; padding:18px; position:relative; overflow:hidden; }
.oracle-card::before { content:''; position:absolute; top:-30px; right:-30px; width:100px; height:100px; border-radius:50%; background:radial-gradient(circle,var(--glow) 0%,transparent 70%); }
.oracle-top { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
.oracle-avi { width:44px; height:44px; border-radius:13px; background:linear-gradient(135deg,var(--accent) 0%,#a259f7 100%); display:flex; align-items:center; justify-content:center; font-size:20px; }
.oracle-name { font-size:15px; font-weight:800; margin-bottom:2px; }
.oracle-sub { font-size:11px; color:var(--text2); }
.oracle-input-row { display:flex; gap:8px; }
.oracle-input { flex:1; background:var(--bg2); border:1px solid var(--line2); border-radius:11px; padding:10px 13px; color:var(--text); font-family:var(--ff); font-size:13px; outline:none; }
.oracle-input::placeholder { color:var(--text3); }
.oracle-send { width:40px; height:40px; border-radius:11px; background:var(--accent); border:none; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; flex-shrink:0; }
.share-card { margin:0 16px 16px; background:var(--bg2); border:1px solid var(--line); border-radius:16px; padding:15px; display:flex; align-items:center; gap:13px; cursor:pointer; transition:border-color 0.2s; }
.share-card:hover { border-color:var(--line2); }
.share-ic { width:42px; height:42px; border-radius:12px; background:var(--bg3); display:flex; align-items:center; justify-content:center; font-size:19px; flex-shrink:0; }
.share-text h4 { font-size:13px; font-weight:700; margin-bottom:2px; }
.share-text p  { font-size:11px; color:var(--text3); }
.share-arrow { color:var(--accent2); font-size:14px; margin-left:auto; }
.alert-item { display:flex; gap:11px; padding:13px 16px; background:var(--bg2); border:1px solid var(--line); border-radius:13px; margin:0 16px 7px; cursor:pointer; transition:border-color 0.2s; }
.alert-item:hover { border-color:var(--line2); }
.alert-item.unread { border-left:3px solid var(--accent); }
.alert-ic { width:38px; height:38px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:17px; flex-shrink:0; }
.alert-c { flex:1; min-width:0; }
.alert-ttl { font-size:13px; font-weight:600; margin-bottom:2px; }
.alert-sub { font-size:11px; color:var(--text2); margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.alert-t { font-size:10px; color:var(--text3); }

/* PRO TERMINAL */
.term-wrap { padding:16px; }
.pgrid { display:grid; grid-template-columns:1fr 1fr; gap:7px; margin-bottom:11px; }
.pstat { background:var(--bg2); border:1px solid var(--line2); border-radius:8px; padding:9px 11px; }
.psl { font-family:var(--fm); font-size:9px; color:var(--text3); letter-spacing:1px; margin-bottom:3px; }
.psv { font-family:var(--fm); font-size:15px; font-weight:700; }
.term-hdr { display:flex; align-items:center; justify-content:space-between; padding:7px 11px; background:var(--bg2); border:1px solid var(--line2); border-radius:8px 8px 0 0; border-bottom:none; }
.term-title { color:var(--accent); font-family:var(--fm); font-size:10px; letter-spacing:1px; }
.term-st { display:flex; gap:11px; font-family:var(--fm); font-size:9px; color:var(--text3); }
.tlive { color:var(--green); }
.term-tbl { width:100%; border-collapse:collapse; background:var(--bg2); border:1px solid var(--line2); border-radius:0 0 8px 8px; overflow:hidden; }
.term-tbl th { padding:7px 9px; text-align:left; font-family:var(--fm); font-size:9px; letter-spacing:1px; color:var(--text3); border-bottom:1px solid var(--line); background:var(--bg3); font-weight:400; }
.term-tbl th.r { text-align:right; }
.term-tbl td { padding:8px 9px; border-bottom:1px solid var(--line); vertical-align:middle; }
.term-tbl tr:last-child td { border-bottom:none; }
.term-tbl tr:hover td { background:var(--bg3); cursor:pointer; }
.td-s { font-family:var(--fm); font-weight:700; color:var(--text); font-size:12px; }
.td-n { color:var(--text3); font-size:9px; font-family:var(--fm); max-width:70px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.td-p { text-align:right; font-family:var(--fm); font-size:11px; color:var(--text); }
.td-c { text-align:right; font-family:var(--fm); font-size:11px; font-weight:700; }
.td-v { text-align:right; font-family:var(--fm); font-size:11px; color:var(--text2); }
.td-t { text-align:center; font-family:var(--fm); font-size:9px; }

/* SETTINGS */
.settings-page { padding:16px; }
.s-prof { background:linear-gradient(135deg,var(--bg3) 0%,rgba(88,101,242,.1) 100%); border:1px solid var(--line2); border-radius:21px; padding:20px; margin-bottom:20px; display:flex; align-items:center; gap:14px; }
.s-avi { width:58px; height:58px; border-radius:17px; background:linear-gradient(135deg,var(--accent) 0%,#a259f7 100%); display:flex; align-items:center; justify-content:center; font-size:25px; flex-shrink:0; }
.s-name { font-size:17px; font-weight:800; margin-bottom:3px; }
.s-sub { font-size:11px; color:var(--text2); margin-bottom:8px; }
.cwbtn { display:inline-block; padding:5px 14px; background:var(--accent); border-radius:18px; font-size:11px; font-weight:700; color:#fff; cursor:pointer; border:none; font-family:var(--ff); }
.sg { margin-bottom:20px; }
.sgl { font-size:10px; font-weight:700; letter-spacing:1.5px; color:var(--text3); text-transform:uppercase; margin-bottom:7px; padding:0 2px; }
.si { display:flex; align-items:center; gap:11px; padding:13px 15px; background:var(--bg2); border:1px solid var(--line); border-radius:13px; margin-bottom:5px; cursor:pointer; transition:background 0.15s; user-select:none; }
.si:active { background:var(--bg3); }
.si-ic { width:34px; height:34px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
.si-tx { flex:1; }
.si-tx h4 { font-size:13px; font-weight:600; margin-bottom:1px; }
.si-tx p  { font-size:11px; color:var(--text3); }
.si-r { color:var(--text3); font-size:12px; }
.tog { width:44px; height:25px; border-radius:13px; background:var(--bg4); border:1px solid var(--line2); position:relative; cursor:pointer; transition:background .25s; flex-shrink:0; }
.tog.on { background:var(--accent); border-color:var(--accent); }
.tog-t { position:absolute; width:19px; height:19px; border-radius:50%; background:#fff; top:2px; left:2px; transition:left .25s; box-shadow:0 2px 5px rgba(0,0,0,.3); }
.tog.on .tog-t { left:21px; }
.main-theme-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:6px; }
.mtheme { padding:14px 8px; border-radius:13px; text-align:center; cursor:pointer; transition:all 0.2s; border:2px solid var(--line); position:relative; }
.mtheme.sel { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); }
.mtheme-preview { width:32px; height:32px; border-radius:10px; margin:0 auto 6px; border:1px solid rgba(0,0,0,0.1); }
.mtheme-name { font-size:10px; font-weight:700; }
.mtheme.sel::after { content:'\2713'; position:absolute; top:5px; right:7px; font-size:10px; color:var(--accent); font-weight:900; }
.palette-swatches { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:14px; }
.swatch { height:44px; border-radius:12px; cursor:pointer; transition:all 0.2s; position:relative; border:2px solid transparent; }
.swatch:active { transform:scale(0.92); }
.swatch.selected::after { content:'\2713'; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:900; color:#fff; text-shadow:0 1px 4px rgba(0,0,0,.5); }
.swatch.selected { border-color:#fff; box-shadow:0 0 0 3px rgba(255,255,255,0.2); }
.custom-row { display:flex; align-items:center; gap:8px; margin-top:10px; }
.custom-color-input { width:44px; height:44px; border-radius:12px; border:1px solid var(--line2); background:var(--bg3); cursor:pointer; padding:4px; overflow:hidden; }
.custom-hex { flex:1; background:var(--bg3); border:1px solid var(--line2); border-radius:11px; padding:10px 12px; color:var(--text); font-family:var(--fm); font-size:12px; outline:none; transition:border-color 0.2s; }
.custom-hex:focus { border-color:var(--accent); }
.custom-apply { padding:10px 14px; background:var(--accent); border:none; border-radius:11px; color:#fff; font-family:var(--ff); font-size:12px; font-weight:700; cursor:pointer; white-space:nowrap; }
.font-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
.font-opt { padding:14px 8px; background:var(--bg2); border:2px solid var(--line); border-radius:13px; text-align:center; cursor:pointer; transition:all 0.2s; }
.font-opt.sel { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); }
.font-preview { font-size:18px; font-weight:800; margin-bottom:4px; }
.font-label { font-size:10px; color:var(--text2); }
.font-opt.sel .font-label { color:var(--accent); }
.vf { text-align:center; padding:24px 0 8px; }
.vl { font-size:26px; font-weight:900; background:linear-gradient(135deg,var(--text) 0%,var(--accent2) 60%,#a259f7 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:3px; }
.vs { font-size:11px; color:var(--text3); }

/* BOTTOM NAV - 5 slots */
.bnav {
  position:fixed; bottom:0; left:0; right:0; height:var(--nav-h);
  background:rgba(8,9,15,.97); backdrop-filter:blur(28px); -webkit-backdrop-filter:blur(28px);
  border-top:1px solid var(--line); display:flex; align-items:center;
  justify-content:space-around; padding:0 2px 4px; z-index:700;
  transition:background 0.3s;
}
body.theme-white .bnav, body.theme-cream .bnav { background:rgba(248,249,252,0.97); }
.bn { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; padding:9px 2px 4px; cursor:pointer; border-radius:11px; transition:all .15s; -webkit-tap-highlight-color:transparent; position:relative; min-width:0; }
.bn-ic { font-size:19px; line-height:1; transition:transform .2s; }
.bn-lb { font-size:9px; color:var(--text3); font-weight:500; transition:color .2s; white-space:nowrap; overflow:hidden; max-width:100%; text-overflow:ellipsis; }
.bn.active .bn-ic { transform:scale(1.12); }
.bn.active .bn-lb { color:var(--accent2); }
.bnav.edit-mode .bn { border:1.5px dashed var(--accent); margin:2px; border-radius:10px; }

/* NAV EDIT */
.nav-edit-banner { position:fixed; top:0; left:0; right:0; z-index:800; background:var(--accent); padding:10px 16px; display:none; justify-content:space-between; align-items:center; }
.nav-edit-banner.visible { display:flex; }
.nav-edit-banner span { font-size:13px; font-weight:700; color:#fff; }
.nav-edit-done { padding:6px 16px; background:rgba(255,255,255,0.2); border:none; border-radius:18px; color:#fff; font-family:var(--ff); font-size:12px; font-weight:700; cursor:pointer; }
.nav-sheet { position:fixed; bottom:0; left:0; right:0; z-index:900; background:var(--bg2); border-top:1px solid var(--line2); border-radius:20px 20px 0 0; padding:16px; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.25,0.46,0.45,0.94); }
.nav-sheet.open { transform:translateY(0); }
.nav-sheet-title { font-size:13px; font-weight:700; text-align:center; margin-bottom:14px; color:var(--text2); }
.nav-options { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
.nav-opt { padding:12px 6px; background:var(--bg3); border:1px solid var(--line); border-radius:12px; text-align:center; cursor:pointer; transition:all 0.2s; }
.nav-opt.in-use { border-color:var(--line2); opacity:0.4; pointer-events:none; }
.nav-opt-ic { font-size:20px; margin-bottom:4px; }
.nav-opt-lb { font-size:10px; color:var(--text2); font-weight:500; }

/* PiP - safe bottom offset on small screens */
.pip { position:fixed; bottom:calc(var(--nav-h) + 12px); right:13px; width:185px; background:var(--bg2); border:1px solid var(--accent); border-radius:17px; box-shadow:0 16px 48px rgba(0,0,0,.6),0 0 0 1px var(--glow); z-index:600; display:none; overflow:hidden; }
.pip.on { display:block; animation:popin .2s cubic-bezier(.34,1.56,.64,1); }
@keyframes popin { from{transform:scale(.8) translateY(8px);opacity:0} to{transform:scale(1) translateY(0);opacity:1} }
.pip-bar { background:var(--bg3); padding:9px 11px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line); }
.pip-sym { font-size:12px; font-weight:800; }
.pip-x { background:none; border:none; color:var(--text3); cursor:pointer; font-size:14px; padding:0; line-height:1; }
.pip-bd { padding:11px; }
.pip-p { font-family:var(--fm); font-size:19px; font-weight:700; margin-bottom:2px; }
.pip-c { font-size:11px; font-weight:700; margin-bottom:9px; }
.pip-mini { height:46px; background:var(--bg3); border-radius:7px; margin-bottom:9px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
.pip-tr { width:100%; padding:7px; background:var(--accent); border:none; border-radius:9px; color:#fff; font-family:var(--ff); font-size:11px; font-weight:700; cursor:pointer; }

/* SKELETONS */
.sk { background:linear-gradient(90deg,var(--bg2) 25%,var(--bg3) 50%,var(--bg2) 75%); background-size:400% 100%; animation:sk 1.4s ease infinite; border-radius:12px; margin-bottom:8px; }
@keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* OVERLAY */
.sheet-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:850; display:none; }
.sheet-overlay.visible { display:block; }

</style>
</head>
<body>


<!-- Nav Edit Banner -->
<div class="nav-edit-banner" id="navEditBanner">
  <span>Tap a slot to change it</span>
  <button class="nav-edit-done" onclick="exitNavEdit()">Done</button>
</div>

<!-- Sheet Overlay -->
<div class="sheet-overlay" id="sheetOverlay" onclick="closeNavSheet()"></div>

<!-- Nav Picker Sheet -->
<div class="nav-sheet" id="navSheet">
  <div class="nav-sheet-title">Choose tab for slot <span id="slotLabel">2</span></div>
  <div class="nav-options" id="navOptions"></div>
</div>

<!-- HEADER -->
<div class="hdr" id="mainHdr">
  <div class="hdr-top">
    <div class="logo" onclick="navTo('home')">AGORA</div>
    <div class="srch">
      <span class="srch-ic">&#9901;</span>
      <input id="searchInput" type="text" placeholder="Search tokens, communities...">
    </div>
    <div class="hbtns">
      <div class="hbtn" id="proBtn">&#9889;</div>
      <div class="hbtn" onclick="navTo('settings')">&#9881;</div>
    </div>
  </div>

  <!-- Home Tool Bar -->
  <div class="tool-bar" id="toolBar">
    <div class="tab-pills" id="tabPills"></div>
    <div class="tool-panel" id="toolPanel"></div>
  </div>

  <!-- Contextual Bar (other tabs) -->
  <div class="ctx-bar" id="ctxBar">
    <div class="ctx-pills" id="ctxPills"></div>
  </div>
</div>

<!-- HOME PAGE -->
<div class="page active" id="page-home">
  <div class="home-pages-wrap" id="homeWrap">
    <div class="home-pages" id="homePages"></div>
  </div>
  <div class="page-dots" id="pageDots"></div>
</div>

<!-- DISCOVER PAGE -->
<div class="page" id="page-discover">
  <div class="frow" id="discoverFilters">
    <div class="fc active" data-f="all">All</div>
    <div class="fc" data-f="safe">üü¢ Safe</div>
    <div class="fc" data-f="community">üü° Community</div>
    <div class="fc" data-f="degen">üî¥ Degen</div>
    <div class="fc" data-f="gainers">üöÄ Gainers</div>
    <div class="fc" data-f="losers">üìâ Losers</div>
  </div>
  <div class="discover-list" id="discoverList">
    <div class="sk" style="height:62px;"></div>
    <div class="sk" style="height:62px;"></div>
    <div class="sk" style="height:62px;"></div>
    <div class="sk" style="height:62px;"></div>
  </div>
</div>

<!-- TRENCHES PAGE -->
<div class="page trenches-page" id="page-trenches">
  <div class="trench-filters">
    <!-- Age filters -->
    <div class="tf active" data-ftype="age" onclick="setTrenchFilter('age','all',this)">All</div>
    <div class="tf" data-ftype="age" onclick="setTrenchFilter('age','1h',this)">1h</div>
    <div class="tf" data-ftype="age" onclick="setTrenchFilter('age','6h',this)">6h</div>
    <div class="tf" data-ftype="age" onclick="setTrenchFilter('age','24h',this)">24h</div>
    <!-- Source filters -->
    <div class="tf" data-ftype="src" style="margin-left:6px;" onclick="setTrenchFilter('src','all',this)">All Sources</div>
    <div class="tf src-dex" data-ftype="src" onclick="setTrenchFilter('src','dex',this)">DEX Paid</div>
    <div class="tf src-agora" data-ftype="src" onclick="setTrenchFilter('src','agora',this)">Agora</div>
    <div class="tf src-organic" data-ftype="src" onclick="setTrenchFilter('src','organic',this)">Organic</div>
    <!-- Tier filters -->
    <div class="tf" data-ftype="tier" style="margin-left:6px;" onclick="setTrenchFilter('tier','all',this)">All Tiers</div>
    <div class="tf" data-ftype="tier" onclick="setTrenchFilter('tier','safe',this)">üü¢</div>
    <div class="tf" data-ftype="tier" onclick="setTrenchFilter('tier','community',this)">üü°</div>
    <div class="tf" data-ftype="tier" onclick="setTrenchFilter('tier','degen',this)">üî¥</div>
  </div>
  <div class="trench-divider">New Launches</div>
  <div class="trench-list" id="trenchList">
    <div class="sk" style="height:62px;"></div>
    <div class="sk" style="height:62px;"></div>
    <div class="sk" style="height:62px;"></div>
    <div class="sk" style="height:62px;"></div>
  </div>
</div>

<!-- CHARTS PAGE -->
<div class="page" id="page-charts">
  <div class="charts-page" id="chartsInner">
    <div class="chart-empty">
      <div class="chart-empty-ic">üìä</div>
      <h3>No charts open</h3>
      <p>Add a chart from Discover or tap below</p>
      <button class="chart-empty-btn" onclick="addChartTab()">+ Add Chart</button>
    </div>
  </div>
</div>

<!-- SWAP PAGE -->
<div class="page" id="page-swap">
  <div class="swap-page" id="swapInner">
    <!-- rendered by renderSwapPage() -->
  </div>
</div>

<!-- COMMS PAGE -->
<div class="page comms-page" id="page-comms">

  <div style="padding:16px 16px 0;">
    <div class="oracle-card">
      <div class="oracle-top">
        <div class="oracle-avi">üîÆ</div>
        <div>
          <div class="oracle-name">Agora Oracle</div>
          <div class="oracle-sub">AI assistant - Ask anything about any token</div>
        </div>
      </div>
      <div class="oracle-input-row">
        <input class="oracle-input" placeholder="Is $FROG safe? What is $WIF doing?...">
        <button class="oracle-send">&#8593;</button>
      </div>
    </div>
  </div>

  <div style="padding:12px 16px 0;">
    <div class="share-card" onclick="shareLayout()">
      <div class="share-ic">üì§</div>
      <div class="share-text">
        <h4>Share My Layout</h4>
        <p>Let others copy your Agora setup</p>
      </div>
      <div class="share-arrow">&#8250;</div>
    </div>
  </div>

  <div style="padding:16px 16px 8px;">
    <div class="sh"><div class="st">üí¨ Chats</div><div class="sm">+ New</div></div>
  </div>

  <div class="chat-list">
    <div class="chat-item unread">
      <div class="chat-avi" style="background:rgba(0,229,160,0.12);">üê∏<div class="chat-online"></div></div>
      <div class="chat-info">
        <div class="chat-top"><div class="chat-name">$FROG Official</div><div class="chat-time">2m</div></div>
        <div class="chat-preview">whale just bought 2M üî•üî•üî•</div>
        <div class="chat-meta">
          <span class="chat-badge tt safe">SAFE</span>
          <span style="font-size:10px;color:var(--text3);">847 online</span>
          <div class="chat-unread-count">12</div>
        </div>
      </div>
    </div>
    <div class="chat-item unread">
      <div class="chat-avi" style="background:rgba(255,190,61,0.12);">üêï<div class="chat-online"></div></div>
      <div class="chat-info">
        <div class="chat-top"><div class="chat-name">WIF Army</div><div class="chat-time">8m</div></div>
        <div class="chat-preview">new roadmap dropped, check announcements</div>
        <div class="chat-meta">
          <span class="chat-badge tt community">COMMUNITY</span>
          <span style="font-size:10px;color:var(--text3);">234 online</span>
          <div class="chat-unread-count">3</div>
        </div>
      </div>
    </div>
    <div class="chat-item">
      <div class="chat-avi" style="background:rgba(255,61,107,0.12);">üíé</div>
      <div class="chat-info">
        <div class="chat-top"><div class="chat-name">Degen Corner</div><div class="chat-time">1h</div></div>
        <div class="chat-preview">anyone else watching $MOON?</div>
        <div class="chat-meta">
          <span class="chat-badge tt degen">DEGEN</span>
          <span style="font-size:10px;color:var(--text3);">1.2K online</span>
        </div>
      </div>
    </div>
    <div class="chat-item">
      <div class="chat-avi" style="background:rgba(88,101,242,0.12);">üì±</div>
      <div class="chat-info">
        <div class="chat-top"><div class="chat-name">Telegram: PEPE Official</div><div class="chat-time">2h</div></div>
        <div class="chat-preview">CTO just posted the new roadmap üöÄ</div>
        <div class="chat-meta">
          <span style="font-size:10px;background:rgba(88,101,242,0.15);color:var(--accent2);padding:2px 6px;border-radius:4px;font-weight:700;">TG</span>
        </div>
      </div>
    </div>
  </div>

  <div style="padding:0 16px 8px;">
    <div class="sh"><div class="st">üîî Alerts</div><div class="sm">See all</div></div>
  </div>
  <div class="alert-item unread">
    <div class="alert-ic" style="background:rgba(0,229,160,0.1);">üèÜ</div>
    <div class="alert-c">
      <div class="alert-ttl">$FROG hit 10K holders</div>
      <div class="alert-sub">Community page milestone unlocked</div>
      <div class="alert-t">2 min ago</div>
    </div>
    <div class="chat-badge tt safe">SAFE</div>
  </div>
  <div class="alert-item unread">
    <div class="alert-ic" style="background:rgba(255,61,107,0.1);">üö®</div>
    <div class="alert-c">
      <div class="alert-ttl">Rug Warning: $SAFEMOON2</div>
      <div class="alert-sub">Dev wallet moved 85% of supply</div>
      <div class="alert-t">Yesterday</div>
    </div>
    <div class="chat-badge tt degen">ALERT</div>
  </div>
  <div style="height:16px;"></div>
</div>

<!-- SETTINGS PAGE -->
<div class="page" id="page-settings">
  <div class="settings-page">
    <div class="s-prof">
      <div class="s-avi">üë§</div>
      <div>
        <div class="s-name">Your Wallet</div>
        <div class="s-sub">Connect to unlock full Agora</div>
        <button class="cwbtn">Connect Wallet</button>
      </div>
    </div>

    <div class="sg">
      <div class="sgl">App Theme</div>
      <div class="main-theme-grid" id="mainThemeGrid"></div>
    </div>

    <div class="sg">
      <div class="sgl">Accent Color <span id="accentLabel" style="font-size:10px;color:var(--accent);font-weight:700;letter-spacing:0;text-transform:none;"></span></div>
      <div class="palette-swatches" id="accentSwatches"></div>
      <div class="custom-row">
        <input type="color" class="custom-color-input" id="customPicker" value="#5865f2">
        <input type="text" class="custom-hex" id="customHex" placeholder="#5865f2" maxlength="7">
        <button class="custom-apply" onclick="applyCustom()">Apply</button>
      </div>
    </div>

    <div class="sg">
      <div class="sgl">Font Style</div>
      <div class="font-grid" id="fontGrid"></div>
    </div>

    <div class="sg">
      <div class="sgl">Bottom Navigation</div>
      <div class="si" onclick="enterNavEdit()">
        <div class="si-ic" style="background:rgba(88,101,242,0.1);">üß≠</div>
        <div class="si-tx"><h4>Customize Tabs</h4><p>Long press any tab or tap here</p></div>
        <div class="si-r">&#8250;</div>
      </div>
    </div>

    <div class="sg">
      <div class="sgl">Trading</div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(88,101,242,0.1);">üëÅ</div>
        <div class="si-tx"><h4>Picture in Picture</h4><p>Float chart while browsing</p></div>
        <div class="tog on" data-k="pip"><div class="tog-t"></div></div>
      </div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(0,229,160,0.1);">&#9889;</div>
        <div class="si-tx"><h4>Quick Swap</h4><p>One-tap Jupiter trades</p></div>
        <div class="tog on" data-k="swap"><div class="tog-t"></div></div>
      </div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(255,190,61,0.1);">üîÑ</div>
        <div class="si-tx"><h4>Auto Refresh</h4><p>Update every 30 seconds</p></div>
        <div class="tog on" data-k="refresh"><div class="tog-t"></div></div>
      </div>
    </div>

    <div class="sg">
      <div class="sgl">Safety &amp; Alerts</div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(0,229,160,0.1);">üõ°</div>
        <div class="si-tx"><h4>Safety Scores</h4><p>Safe / Community / Degen tiers</p></div>
        <div class="tog on" data-k="safety"><div class="tog-t"></div></div>
      </div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(255,61,107,0.1);">üö®</div>
        <div class="si-tx"><h4>Rug Warnings</h4><p>Dev wallet movement alerts</p></div>
        <div class="tog on" data-k="rug"><div class="tog-t"></div></div>
      </div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(255,190,61,0.1);">üêã</div>
        <div class="si-tx"><h4>Whale Tracker</h4><p>Large wallet movements</p></div>
        <div class="tog" data-k="whale"><div class="tog-t"></div></div>
      </div>
    </div>

    <div class="sg">
      <div class="sgl">Community</div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(88,101,242,0.1);">üì±</div>
        <div class="si-tx"><h4>Telegram Integration</h4><p>Pull groups into Comms</p></div>
        <div class="tog" data-k="tg"><div class="tog-t"></div></div>
      </div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(255,190,61,0.1);">üê¶</div>
        <div class="si-tx"><h4>Twitter / X Feed</h4><p>Monitored accounts in Comms</p></div>
        <div class="tog" data-k="tw"><div class="tog-t"></div></div>
      </div>
      <div class="si" onclick="togItem(this)">
        <div class="si-ic" style="background:rgba(0,229,160,0.1);">üó≥</div>
        <div class="si-tx"><h4>Vote Notifications</h4><p>Community governance alerts</p></div>
        <div class="tog on" data-k="votes"><div class="tog-t"></div></div>
      </div>
    </div>

    <div class="sg">
      <div class="sgl">About</div>
      <div class="si">
        <div class="si-ic" style="background:rgba(88,101,242,0.1);">üìã</div>
        <div class="si-tx"><h4>Terms of Service</h4><p>Read our terms</p></div>
        <div class="si-r">&#8250;</div>
      </div>
      <div class="si">
        <div class="si-ic" style="background:rgba(88,101,242,0.1);">üîí</div>
        <div class="si-tx"><h4>Privacy Policy</h4></div>
        <div class="si-r">&#8250;</div>
      </div>
      <div class="si">
        <div class="si-ic" style="background:rgba(255,61,107,0.1);">üêõ</div>
        <div class="si-tx"><h4>Report a Bug</h4><p>Help improve Agora</p></div>
        <div class="si-r">&#8250;</div>
      </div>
    </div>

    <div class="vf">
      <div class="vl">AGORA</div>
      <div class="vs">v0.4.0 Alpha - Built on Solana</div>
    </div>
  </div>
</div>

<!-- PiP -->
<div class="pip" id="pip">
  <div class="pip-bar">
    <div class="pip-sym" id="pip-s">-</div>
    <button class="pip-x" onclick="closePip()">&#10005;</button>
  </div>
  <div class="pip-bd">
    <div class="pip-p" id="pip-p">$0.00</div>
    <div class="pip-c" id="pip-c">+0.00%</div>
    <div class="pip-mini" id="pip-m"></div>
    <button class="pip-tr" onclick="closePip()">Trade on Jupiter &#8594;</button>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bnav" id="bnav"></div>

<script>
// ================================================
// AGORA v4 - api.js
// Data fetching + token normalization only
// ================================================

const EMOJIS = ['üê∏','üêï','üöÄ','üåô','üíé','‚ö°','üî•','ü¶ä','üêØ','ü¶Å','üêâ','ü¶Ñ','üçÄ','üéØ','üí´','üåä','üé™','üèÜ','üëë','üé≠','ü§ñ','üëæ','üéÆ','üèÑ','ü¶ã'];
const COLORS  = ['#5865f2','#00e5a0','#ffbe3d','#ff3d6b','#a259f7','#3b82f6','#f59e0b','#10b981','#ec4899','#06b6d4'];

function em(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
  return EMOJIS[Math.abs(h) % EMOJIS.length];
}

function cl(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
  return COLORS[Math.abs(h) % COLORS.length];
}

function calcTier(pair) {
  const liq = parseFloat(pair.liquidity?.usd) || 0;
  const vol = parseFloat(pair.volume?.h24)    || 0;
  if (liq > 100000 && vol > 50000) return 'safe';
  if (liq > 10000  || vol > 5000)  return 'community';
  return 'degen';
}

// Simulate listing source ‚Äî will be real data later
function calcListingSource(pair) {
  const age = pair.pairCreatedAt ? (Date.now() - pair.pairCreatedAt) / 3600000 : 99;
  const vol = parseFloat(pair.volume?.h24) || 0;
  if (vol > 80000) return 'dex';
  if (vol > 20000) return 'agora';
  return 'organic';
}

function normalizeToken(p) {
  return {
    id:      p.pairAddress,
    address: p.baseToken.address,
    symbol:  p.baseToken.symbol,
    name:    p.baseToken.name,
    price:   parseFloat(p.priceUsd)        || 0,
    change:  parseFloat(p.priceChange?.h24) || 0,
    vol:     parseFloat(p.volume?.h24)      || 0,
    liq:     parseFloat(p.liquidity?.usd)   || 0,
    mcap:    parseFloat(p.fdv)              || 0,
    age:     p.pairCreatedAt ? (Date.now() - p.pairCreatedAt) / 3600000 : 99,
    tier:    calcTier(p),
    source:  calcListingSource(p),
    emoji:   em(p.baseToken.symbol),
    color:   cl(p.baseToken.symbol),
  };
}

async function fetchTokens() {
  try {
    const res  = await fetch('https://api.dexscreener.com/latest/dex/search/?q=SOL');
    const data = await res.json();
    if (!data.pairs) return;

    state.tokens = data.pairs
      .filter(p => p.chainId === 'solana' && parseFloat(p.priceUsd) > 0 && p.baseToken?.symbol)
      .slice(0, 60)
      .map(normalizeToken);

    // Trenches = newest pairs
    state.trenches = state.tokens
      .slice()
      .sort((a, b) => a.age - b.age);

    renderHome();
    renderDiscover();
    renderTrenches();
    setTimeout(renderTweets, 100);
  } catch (e) {
    console.error('fetchTokens:', e);
  }
}

</script>
<script>
// ================================================
// AGORA v4 - app.js
// ================================================

// ------------------------------------------------
// GLOBAL STATE
// ------------------------------------------------
const state = {
  activePage:    'home',
  navSlots:      null,
  cfg:           null,
  tokens:        [],
  trenches:      [],
  searchTerm:    '',
  currentFilter: 'all',
  homePagesIdx:  0,
  chartTabs:     [],
  activeChartTab: null,
  trenchAge:     'all',
  trenchSrc:     'all',
  trenchTier:    'all',
};

// ------------------------------------------------
// CONSTANTS
// ------------------------------------------------
const ACCENTS = [
  {n:'Pump.fun',  h:'#00ff88', g:'rgba(0,255,136,0.18)'},
  {n:'Bonk',      h:'#f7931a', g:'rgba(247,147,26,0.18)'},
  {n:'Trojan',    h:'#3b82f6', g:'rgba(59,130,246,0.18)'},
  {n:'Axiom',     h:'#e11d48', g:'rgba(225,29,72,0.18)'},
  {n:'Agora Blue',h:'#5865f2', g:'rgba(88,101,242,0.18)'},
  {n:'Sol Green', h:'#00e5a0', g:'rgba(0,229,160,0.15)'},
  {n:'Purple',    h:'#a259f7', g:'rgba(162,89,247,0.15)'},
  {n:'Gold',      h:'#ffbe3d', g:'rgba(255,190,61,0.15)'},
  {n:'Pink',      h:'#ec4899', g:'rgba(236,72,153,0.15)'},
  {n:'Arctic',    h:'#e2e8f0', g:'rgba(226,232,240,0.12)'},
];

const THEMES = [
  {k:'dark',  label:'Space', bg:'#08090f', bg2:'#0e1018', bg3:'#141720', bg4:'#1a1e2a'},
  {k:'navy',  label:'Navy',  bg:'#020818', bg2:'#05102a', bg3:'#081540', bg4:'#0d1f52'},
  {k:'white', label:'White', bg:'#f8f9fc', bg2:'#ffffff', bg3:'#f0f2f8', bg4:'#e8ebf5'},
  {k:'cream', label:'Cream', bg:'#f5f0e8', bg2:'#faf7f2', bg3:'#ede8df', bg4:'#e4ddd2'},
];

const FONTS = [
  {k:'modern',  label:'Modern',  ff:'Outfit',          preview:'Ag'},
  {k:'sharp',   label:'Sharp',   ff:'Barlow Condensed', preview:'AG'},
  {k:'elegant', label:'Elegant', ff:'DM Serif Display', preview:'Ag'},
];

const ALL_NAV_PAGES = [
  {id:'home',     ic:'üè†', lb:'Home',     locked:true},
  {id:'discover', ic:'üîç', lb:'Discover'},
  {id:'comms',    ic:'üì°', lb:'Comms'},
  {id:'settings', ic:'‚öô',  lb:'Settings'},
  {id:'trenches', ic:'‚õè',  lb:'Trenches'},
  {id:'charts',   ic:'üìä', lb:'Charts'},
  {id:'swap',     ic:'üîÑ', lb:'Swap'},
  {id:'alerts',   ic:'üîî', lb:'Alerts'},
  {id:'watchlist',ic:'‚≠ê', lb:'Watch'},
];

const TOOL_CATS = [
  {
    id:'community', label:'üèõ Community', emoji:'üèõ',
    tools:[
      {id:'comm_feed',     ic:'üèõ', n:'Community Feed',  on:true},
      {id:'comm_tweets',   ic:'üî•', n:'Trending Tweets', on:true},
      {id:'comm_live',     ic:'üì°', n:'Live Activity',   on:true},
      {id:'comm_forum',    ic:'üí¨', n:'Forum Activity',  on:false},
      {id:'comm_votes',    ic:'üó≥', n:'Community Votes', on:false},
      {id:'comm_launches', ic:'üöÄ', n:'New Launches',    on:false},
      {id:'comm_picks',    ic:'üèÜ', n:'Top Picks',       on:false},
    ]
  },
  {
    id:'trader', label:'üìà Trader', emoji:'üìà',
    tools:[
      {id:'tr_gainers',   ic:'üöÄ', n:'Top Gainers',    on:true},
      {id:'tr_watchlist', ic:'‚≠ê', n:'Watchlist Strip', on:true},
      {id:'tr_volume',    ic:'üìä', n:'Volume Leaders',  on:false},
      {id:'tr_new',       ic:'‚ú®', n:'New Pairs',       on:false},
      {id:'tr_losers',    ic:'üìâ', n:'Losers',          on:false},
      {id:'tr_trending',  ic:'üìà', n:'Trending',        on:false},
      {id:'tr_whales',    ic:'üêã', n:'Whale Moves',     on:false},
    ]
  },
  {
    id:'pro', label:'‚ö° Pro', emoji:'‚ö°',
    tools:[
      {id:'pro_terminal', ic:'üñ•', n:'Terminal',       on:false},
      {id:'pro_stats',    ic:'üìä', n:'Market Stats',   on:false},
      {id:'pro_pressure', ic:'‚ö°', n:'Buy/Sell Press', on:false},
      {id:'pro_liq',      ic:'üíß', n:'Liq Scanner',    on:false},
      {id:'pro_pnl',      ic:'üí∞', n:'Portfolio PnL',  on:false},
    ]
  },
];

const CTX_BARS = {
  discover:  ['All','üü¢ Safe','üü° Community','üî¥ Degen','üöÄ Gainers','üìâ Losers'],
  comms:     ['All','üí¨ Chats','üîî Alerts','üîÆ Oracle','üì§ Share'],
  trenches:  [],
  charts:    [],
  swap:      [],
  alerts:    ['All','Price','Whale','Rug','Milestone'],
  watchlist: ['All','Gainers','Losers','New'],
};

let activeToolCat  = null;
let editingNavSlot = -1;
let longPressTimer = null;

// ------------------------------------------------
// INIT
// ------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  state.cfg = JSON.parse(localStorage.getItem('ag4_cfg') || '{}');
  state.navSlots = state.cfg.navSlots || ['home','discover','comms','trenches','settings'];

  // Restore tool state from cfg
  if (state.cfg.toolState) {
    TOOL_CATS.forEach(cat => {
      cat.tools.forEach(tool => {
        const saved = state.cfg.toolState[tool.id];
        if (saved !== undefined) tool.on = saved;
      });
    });
  }

  buildNav();
  buildToolBar();
  buildSettingsUI();
  restoreAppearance();
  applySettingsToggles();
  renderHome();
  renderTweets();
  startTicker();
  fetchTokens();
  setupSearch();
  setupDiscoverFilters();
  setupSwipe();
  setupProBtn();

  setInterval(() => { if (state.cfg.refresh !== false) fetchTokens(); }, 30000);
  setInterval(() => {
    const e = document.getElementById('pclock');
    if (e) e.textContent = new Date().toTimeString().slice(0,8);
  }, 1000);
});

// ------------------------------------------------
// PRO BUTTON (lightning bolt quick toggle)
// ------------------------------------------------
function setupProBtn() {
  const btn = document.getElementById('proBtn');
  if (!btn) return;
  const proTool = TOOL_CATS.find(c => c.id === 'pro').tools.find(t => t.id === 'pro_terminal');
  btn.classList.toggle('on', proTool && proTool.on);
  btn.onclick = () => {
    if (!proTool) return;
    proTool.on = !proTool.on;
    btn.classList.toggle('on', proTool.on);
    saveToolState();
    renderHome();
  };
}

// ------------------------------------------------
// NAVIGATION
// ------------------------------------------------
function buildNav() {
  const bnav = document.getElementById('bnav');
  bnav.innerHTML = state.navSlots.map((pid, i) => {
    const pg = ALL_NAV_PAGES.find(p => p.id === pid) || ALL_NAV_PAGES[0];
    return `<div class="bn${state.activePage === pid ? ' active' : ''}" data-slot="${i}" data-pid="${pid}"
      onclick="navTo('${pid}')"
      ontouchstart="startLongPress(${i})" ontouchend="endLongPress()" ontouchcancel="endLongPress()"
      onmousedown="startLongPress(${i})" onmouseup="endLongPress()" onmouseleave="endLongPress()">
      <div class="bn-ic">${pg.ic}</div>
      <div class="bn-lb">${pg.lb}</div>
    </div>`;
  }).join('');
}

function navTo(pid) {
  // Close tool panel on navigate
  const panel = document.getElementById('toolPanel');
  if (panel) { panel.classList.remove('open'); activeToolCat = null; }
  document.querySelectorAll('.tpill').forEach(p => p.classList.remove('active','open'));

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.bn').forEach(b => b.classList.remove('active'));

  const pageEl = document.getElementById('page-' + pid);
  if (pageEl) pageEl.classList.add('active');

  const navEl = document.querySelector('[data-pid="' + pid + '"]');
  if (navEl) navEl.classList.add('active');

  state.activePage = pid;
  window.scrollTo(0, 0);
  updateHeaderBars(pid);

  if (pid === 'charts') renderChartsPage();
  if (pid === 'swap')   renderSwapPage();
}

function updateHeaderBars(pid) {
  const toolBar = document.getElementById('toolBar');
  const ctxBar  = document.getElementById('ctxBar');
  const noCtx   = ['home','settings','trenches','charts','swap'];
  toolBar.classList.toggle('visible', pid === 'home');
  ctxBar.classList.toggle('visible', !noCtx.includes(pid));
  if (!noCtx.includes(pid) && pid !== 'home') buildCtxBar(pid);
}

// ------------------------------------------------
// TOOL BAR
// ------------------------------------------------
function buildToolBar() {
  const pills = document.getElementById('tabPills');
  pills.innerHTML = TOOL_CATS.map(cat => `
    <div class="tpill${activeToolCat === cat.id ? ' active open' : ''}" data-cat="${cat.id}" onclick="toggleToolCat('${cat.id}')">
      ${cat.label} <span class="tpill-arrow">&#9662;</span>
    </div>
  `).join('');
}

function toggleToolCat(catId) {
  const panel = document.getElementById('toolPanel');
  const pills = document.querySelectorAll('.tpill');

  if (activeToolCat === catId) {
    activeToolCat = null;
    panel.classList.remove('open');
    pills.forEach(p => p.classList.remove('active','open'));
    return;
  }

  activeToolCat = catId;
  pills.forEach(p => {
    const isThis = p.dataset.cat === catId;
    p.classList.toggle('active', isThis);
    p.classList.toggle('open',   isThis);
  });

  const cat = TOOL_CATS.find(c => c.id === catId);
  if (!cat) return;

  panel.innerHTML = `
    <div class="tool-panel-title">${cat.label} Tools</div>
    <div class="tool-grid">
      ${cat.tools.map(t => `
        <div class="tool-item${t.on ? ' on' : ''}" onclick="toggleTool('${cat.id}','${t.id}',this)">
          <div class="tool-ic">${t.ic}</div>
          <div class="tool-name">${t.n}</div>
          <div class="tool-chk">${t.on ? '&#10003;' : ''}</div>
        </div>
      `).join('')}
    </div>
  `;
  panel.classList.add('open');
}

function toggleTool(catId, toolId, el) {
  const cat  = TOOL_CATS.find(c => c.id === catId);
  const tool = cat && cat.tools.find(t => t.id === toolId);
  if (!tool) return;
  tool.on = !tool.on;
  el.classList.toggle('on', tool.on);
  el.querySelector('.tool-chk').innerHTML = tool.on ? '&#10003;' : '';

  // Keep pro button in sync
  if (toolId === 'pro_terminal') {
    const btn = document.getElementById('proBtn');
    if (btn) btn.classList.toggle('on', tool.on);
  }

  saveToolState();
  renderHome();
}

function saveToolState() {
  if (!state.cfg.toolState) state.cfg.toolState = {};
  TOOL_CATS.forEach(cat => cat.tools.forEach(t => {
    state.cfg.toolState[t.id] = t.on;
  }));
  saveCfg();
}

// ------------------------------------------------
// CTX BAR
// ------------------------------------------------
function buildCtxBar(pid) {
  const pills = document.getElementById('ctxPills');
  const items = CTX_BARS[pid] || [];
  pills.innerHTML = items.map((label, i) => `
    <div class="cpill${i === 0 ? ' active' : ''}" onclick="ctxPillClick(this)">${label}</div>
  `).join('');
}

function ctxPillClick(el) {
  el.closest('.ctx-pills').querySelectorAll('.cpill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
}

// ------------------------------------------------
// HOME PAGES
// ------------------------------------------------
function getActiveTools() {
  const tools = [];
  TOOL_CATS.forEach(cat => cat.tools.filter(t => t.on).forEach(t => tools.push(Object.assign({}, t, {cat: cat.id}))));
  return tools;
}

function renderHome() {
  const activeTools = getActiveTools();
  const pagesEl     = document.getElementById('homePages');
  const dotsEl      = document.getElementById('pageDots');
  if (!pagesEl || !dotsEl) return;

  const sections = activeTools.map(t => buildSection(t));
  const perPage  = 2;
  const pages    = [];
  for (let i = 0; i < sections.length; i += perPage) pages.push(sections.slice(i, i + perPage));
  if (pages.length === 0) {
    pages.push([
      '<div style="padding:40px 20px;text-align:center;color:var(--text3)">' +
      '<div style="font-size:40px;margin-bottom:12px;">üèõ</div>' +
      '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">No tools selected</div>' +
      '<div style="font-size:13px;">Tap the category tabs above to add tools to your home</div>' +
      '</div>'
    ]);
  }

  pagesEl.innerHTML = pages.map(s => '<div class="home-page">' + s.join('') + '</div>').join('');
  dotsEl.innerHTML  = pages.map((_, i) => '<div class="pdot' + (i === state.homePagesIdx ? ' active' : '') + '"></div>').join('');
  goToHomePage(Math.min(state.homePagesIdx, pages.length - 1), false);

  // Re-render tweets if section present
  setTimeout(renderTweets, 50);
}

function buildSection(tool) {
  switch (tool.id) {
    case 'comm_live':    return buildLiveBar();
    case 'comm_feed':    return buildCommunitySection();
    case 'comm_tweets':  return buildTweetsSection();
    case 'tr_gainers':   return buildGainersSection();
    case 'tr_watchlist': return buildWatchlistSection();
    case 'pro_terminal': return buildTerminalSection();
    default:
      return '<div class="sb"><div class="sh"><div class="st">' + tool.ic + ' ' + tool.n + '</div></div>' +
             '<div style="background:var(--bg2);border:1px solid var(--line);border-radius:13px;padding:24px;text-align:center;color:var(--text3);font-size:13px;">Coming soon</div></div>';
  }
}

function buildLiveBar() {
  return '<div class="live-bar" style="margin-bottom:18px;"><div class="ldot"></div>' +
         '<div class="ltxt" id="ltxt"><strong>Loading</strong> live feed...</div></div>';
}

function buildCommunitySection() {
  const top  = state.tokens.slice().sort((a,b) => b.vol - a.vol).slice(0,3);
  const acts = ['Just hit a new ATH', 'Whale entered', 'Team posted update', 'Community vote live', 'New meme dropped'];
  if (!top.length) return '<div class="sb"><div class="sh"><div class="st">üèõ Communities</div><div class="sm">See all</div></div><div class="sk" style="height:180px;"></div></div>';
  return '<div class="sb"><div class="sh"><div class="st">üèõ Communities</div><div class="sm">See all</div></div>' +
    top.map(t => {
      const act = acts[Math.floor(Math.random() * acts.length)];
      return `<div class="cc" onclick="openPip('${t.id}')">
        <div class="cc-banner" style="background:linear-gradient(135deg,${t.color}20 0%,${t.color}06 100%);">
          <div class="cc-banner-bg">${t.emoji}</div><div class="cc-banner-fade"></div>
        </div>
        <div class="cc-body">
          <div class="cc-top">
            <div class="cc-avi" style="background:${t.color}20;">${t.emoji}</div>
            <div class="cc-meta">
              <div class="cc-name">$${t.symbol}<span class="tt ${t.tier}">${t.tier.toUpperCase()}</span></div>
              <div class="cc-stats"><span>üë• ${fn(t.mcap/1000+100).replace('$','')} members</span></div>
            </div>
            <div class="cc-price">
              <div class="ccpv">${fp(t.price)}</div>
              <div class="ccpc ${t.change>=0?'pos':'neg'}">${t.change>=0?'&#9650;':'&#9660;'} ${Math.abs(t.change).toFixed(1)}%</div>
            </div>
          </div>
          <div class="cc-latest"><strong>Latest:</strong> ${act}</div>
          <div class="cc-foot">
            <div class="cc-actions">
              <button class="ca p" onclick="event.stopPropagation();openPip('${t.id}')">View</button>
              <button class="ca s">Forum</button>
            </div>
            <div style="font-size:10px;color:var(--text3);">Vol ${fn(t.vol)}</div>
          </div>
        </div>
      </div>`;
    }).join('') + '</div>';
}

function buildTweetsSection() {
  return '<div class="sb" id="tweetsSection"><div class="sh"><div class="st">üî• Trending Tweets</div><div class="sm">See all</div></div><div id="tweetCards"></div></div>';
}

function buildGainersSection() {
  const gainers = state.tokens.slice().sort((a,b) => b.change - a.change).slice(0,5);
  if (!gainers.length) return '<div class="sb"><div class="sh"><div class="st">üöÄ Top Gainers</div></div><div class="sk" style="height:62px;"></div></div>';
  return '<div class="sb"><div class="sh"><div class="st">üöÄ Top Gainers</div><div class="sm">See all</div></div>' +
    gainers.map(t => tokenRow(t)).join('') + '</div>';
}

function buildWatchlistSection() {
  return '<div class="sb"><div class="sh"><div class="st">‚≠ê Watchlist</div><div class="sm">Edit</div></div>' +
         '<div style="background:var(--bg2);border:1px solid var(--line);border-radius:13px;padding:24px;text-align:center;color:var(--text3);font-size:13px;">No tokens saved yet.<br>Star tokens in Discover to add them.</div></div>';
}

function buildTerminalSection() {
  if (!state.tokens.length) return '<div class="term-wrap"><div class="sk" style="height:200px;"></div></div>';
  const tc = {safe:'var(--green)', community:'var(--gold)', degen:'var(--red)'};
  const ts = {safe:'&#9679;', community:'&#9670;', degen:'&#9650;'};
  const tvol = state.tokens.reduce((a,t) => a + t.vol, 0);
  const gain = state.tokens.filter(t => t.change > 0).length;
  return `<div class="term-wrap">
    <div class="pgrid">
      <div class="pstat"><div class="psl">TOTAL VOL</div><div class="psv">${fn(tvol)}</div></div>
      <div class="pstat"><div class="psl">GAINERS</div><div class="psv pos">${gain}</div></div>
      <div class="pstat"><div class="psl">SAFE</div><div class="psv" style="color:var(--green)">${state.tokens.filter(t=>t.tier==='safe').length}</div></div>
      <div class="pstat"><div class="psl">DEGEN</div><div class="psv" style="color:var(--red)">${state.tokens.filter(t=>t.tier==='degen').length}</div></div>
    </div>
    <div class="term-hdr"><span class="term-title">AGORA // SOLANA</span><div class="term-st"><span class="tlive">&#9679; LIVE</span><span id="pclock">${new Date().toTimeString().slice(0,8)}</span></div></div>
    <div style="overflow-x:auto;"><table class="term-tbl"><thead><tr><th>#</th><th>TOKEN</th><th class="r">PRICE</th><th class="r">24H</th><th class="r">VOL</th><th style="text-align:center">TIER</th></tr></thead><tbody>
      ${state.tokens.slice(0,20).map((t,i) => `<tr onclick="openPip('${t.id}')"><td style="color:var(--text3);font-family:var(--fm);font-size:10px;">${i+1}</td><td><div class="td-s">${t.symbol}</div><div class="td-n">${t.name}</div></td><td class="td-p">${fp(t.price)}</td><td class="td-c ${t.change>=0?'pos':'neg'}">${t.change>=0?'+':''}${t.change.toFixed(2)}%</td><td class="td-v">${fn(t.vol)}</td><td class="td-t" style="color:${tc[t.tier]}">${ts[t.tier]} ${t.tier.toUpperCase()}</td></tr>`).join('')}
    </tbody></table></div></div>`;
}

function tokenRow(t) {
  return `<div class="tr" onclick="openPip('${t.id}')">
    <div class="t-logo" style="background:${t.color}18;">${t.emoji}</div>
    <div class="t-inf">
      <div class="t-name">${t.symbol}<span class="tt ${t.tier}" style="font-size:8px;">${t.tier.toUpperCase()}</span></div>
      <div class="t-sub"><span class="tdot ${t.tier}"></span>${fn(t.mcap)} mcap</div>
    </div>
    <div class="t-spark">${sp(t.change>=0)}</div>
    <div class="t-price">
      <div class="t-pv">${fp(t.price)}</div>
      <div class="t-pc ${t.change>=0?'pos':'neg'}">${t.change>=0?'&#9650;':'&#9660;'} ${Math.abs(t.change).toFixed(1)}%</div>
    </div>
  </div>`;
}

function goToHomePage(idx, animate) {
  const pages = document.getElementById('homePages');
  const dots  = document.querySelectorAll('.pdot');
  if (!pages) return;
  const count = pages.children.length;
  state.homePagesIdx = Math.max(0, Math.min(idx, count - 1));
  if (animate === false) pages.style.transition = 'none';
  pages.style.transform = 'translateX(-' + (state.homePagesIdx * 100) + '%)';
  if (animate === false) setTimeout(() => { pages.style.transition = ''; }, 50);
  dots.forEach((d,i) => d.classList.toggle('active', i === state.homePagesIdx));
}

// ------------------------------------------------
// SWIPE (fixes tool panel conflict)
// ------------------------------------------------
function setupSwipe() {
  const wrap = document.getElementById('homeWrap');
  let startX = 0, startY = 0, startIdx = 0, moved = false;

  wrap.addEventListener('touchstart', e => {
    // Don't start swipe if touch inside open tool panel
    if (document.getElementById('toolPanel').classList.contains('open')) return;
    startX   = e.touches[0].clientX;
    startY   = e.touches[0].clientY;
    startIdx = state.homePagesIdx;
    moved    = false;
  }, {passive:true});

  wrap.addEventListener('touchmove', e => {
    if (document.getElementById('toolPanel').classList.contains('open')) return;
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    if (!moved && Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 8) moved = true;
  }, {passive:true});

  wrap.addEventListener('touchend', e => {
    if (!moved) return;
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx) > 40) {
      goToHomePage(dx < 0 ? startIdx + 1 : startIdx - 1, true);
    }
    moved = false;
  }, {passive:true});
}

// ------------------------------------------------
// TWEETS
// ------------------------------------------------
function renderTweets() {
  const el = document.getElementById('tweetCards');
  if (!el) return;
  const tweets = [
    {a:'@elonmusk',   i:'E', c:'#1d9bf0', txt:'Frogs are underrated üê∏', t:'4h', l:'2.3M',
     tokens:[{s:'FROG',t:'safe',v:450,w:1},{s:'PEPE2',t:'community',v:180},{s:'RIBBIT',t:'community',v:320}]},
    {a:'@CZ_Binance', i:'C', c:'#f0b90b', txt:'The next 100x is hiding in plain sight', t:'6h', l:'1.1M',
     tokens:[{s:'PLAIN',t:'degen',v:78},{s:'SIGHT',t:'degen',v:43}]},
  ];
  el.innerHTML = tweets.map(tw => `
    <div class="twc">
      <div class="twc-hd">
        <div class="twc-avi" style="background:${tw.c}22;color:${tw.c};">${tw.i}</div>
        <div><div class="twc-auth">${tw.a}</div><div class="twc-time">${tw.t} ago</div></div>
      </div>
      <div class="twc-txt">${tw.txt}</div>
      <div class="twc-chips">${tw.tokens.map(t =>
        `<div class="twc-chip ${t.t}"><div class="twc-chip-sym">$${t.s}${t.w?' üèÜ':''}</div><div class="twc-chip-inf">${t.v} votes - ${t.t}</div></div>`
      ).join('')}</div>
      <div class="twc-foot"><span>&#10084;&#65039; ${tw.l}</span><span>üí∞ ${tw.tokens.length} tokens</span><span>+ Claim page</span></div>
    </div>
  `).join('');
}

// ------------------------------------------------
// DISCOVER
// ------------------------------------------------
function setupSearch() {
  const input = document.getElementById('searchInput');
  input.addEventListener('input', e => {
    state.searchTerm = e.target.value.toLowerCase();
    if (state.searchTerm) navTo('discover');
    else if (state.activePage === 'discover') renderDiscover();
    renderDiscover();
  });
}

function setupDiscoverFilters() {
  document.querySelectorAll('.fc').forEach(c => c.addEventListener('click', () => {
    document.querySelectorAll('.fc').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    state.currentFilter = c.dataset.f;
    renderDiscover();
  }));
}

function renderDiscover() {
  const el = document.getElementById('discoverList');
  if (!el) return;
  let list = state.tokens.slice();
  if (state.searchTerm) list = list.filter(t => t.symbol.toLowerCase().includes(state.searchTerm) || t.name.toLowerCase().includes(state.searchTerm));
  if      (state.currentFilter === 'safe')      list = list.filter(t => t.tier === 'safe');
  else if (state.currentFilter === 'community') list = list.filter(t => t.tier === 'community');
  else if (state.currentFilter === 'degen')     list = list.filter(t => t.tier === 'degen');
  else if (state.currentFilter === 'gainers')   list = list.sort((a,b) => b.change - a.change);
  else if (state.currentFilter === 'losers')    list = list.sort((a,b) => a.change - b.change);
  if (!list.length) { el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text3)">No tokens found</div>'; return; }
  el.innerHTML = list.map(t => `
    <div class="tr" onclick="openPip('${t.id}')">
      <div class="t-logo" style="background:${t.color}18;">${t.emoji}</div>
      <div class="t-inf">
        <div class="t-name">${t.symbol}<span class="tt ${t.tier}" style="font-size:8px;">${t.tier.toUpperCase()}</span></div>
        <div class="t-sub"><span class="tdot ${t.tier}"></span>${fn(t.mcap)} mcap - ${fn(t.vol)} vol</div>
      </div>
      <div class="t-spark">${sp(t.change>=0)}</div>
      <div class="t-price">
        <div class="t-pv">${fp(t.price)}</div>
        <div class="t-pc ${t.change>=0?'pos':'neg'}">${t.change>=0?'&#9650;':'&#9660;'} ${Math.abs(t.change).toFixed(1)}%</div>
      </div>
    </div>
  `).join('');
}

// ------------------------------------------------
// TRENCHES
// ------------------------------------------------
function renderTrenches() {
  const el = document.getElementById('trenchList');
  if (!el) return;
  let list = state.trenches.slice();

  if (state.trenchAge === '1h')  list = list.filter(t => t.age <= 1);
  else if (state.trenchAge === '6h')  list = list.filter(t => t.age <= 6);
  else if (state.trenchAge === '24h') list = list.filter(t => t.age <= 24);

  if (state.trenchSrc !== 'all') list = list.filter(t => t.source === state.trenchSrc);
  if (state.trenchTier !== 'all') list = list.filter(t => t.tier === state.trenchTier);

  if (!list.length) { el.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text3);font-size:13px;">No new launches match these filters</div>'; return; }

  const srcLabel = {dex:'DEX PAID', agora:'AGORA', organic:'ORGANIC'};
  el.innerHTML = list.map(t => `
    <div class="trench-row src-${t.source}" onclick="openPip('${t.id}')">
      <div class="t-logo" style="background:${t.color}18;width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;">${t.emoji}</div>
      <div class="t-inf">
        <div class="t-name" style="font-size:13px;font-weight:700;margin-bottom:2px;display:flex;align-items:center;gap:5px;">
          ${t.symbol}<span class="tt ${t.tier}">${t.tier.toUpperCase()}</span>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          <span class="trench-src src-${t.source}">${srcLabel[t.source]}</span>
          <span class="trench-age">${t.age < 1 ? Math.round(t.age*60)+'m' : t.age.toFixed(1)+'h'} ago</span>
        </div>
      </div>
      <div class="t-spark">${sp(t.change>=0)}</div>
      <div class="t-price" style="text-align:right;flex-shrink:0;">
        <div class="t-pv" style="font-family:var(--fm);font-size:11px;font-weight:700;margin-bottom:1px;">${fp(t.price)}</div>
        <div class="t-pc ${t.change>=0?'pos':'neg'}" style="font-size:11px;font-weight:700;">${t.change>=0?'&#9650;':'&#9660;'} ${Math.abs(t.change).toFixed(1)}%</div>
      </div>
    </div>
  `).join('');
}

function setTrenchFilter(type, val, el) {
  state['trench' + type.charAt(0).toUpperCase() + type.slice(1)] = val;
  if (el) {
    el.closest('.trench-filters').querySelectorAll('[data-ftype="' + type + '"]').forEach(b => b.classList.remove('active','age-active','src-dex','src-agora','src-organic'));
    el.classList.add(type === 'age' ? 'age-active' : val === 'all' ? 'active' : 'src-' + val);
  }
  renderTrenches();
}

// ------------------------------------------------
// CHARTS TAB
// ------------------------------------------------
function renderChartsPage() {
  if (state.chartTabs.length === 0) {
    document.getElementById('chartsInner').innerHTML = `
      <div class="chart-empty">
        <div class="chart-empty-ic">üìä</div>
        <h3>No charts open</h3>
        <p>Add a chart from Discover or search for a token below</p>
        <button class="chart-empty-btn" onclick="addChartTab()">+ Add Chart</button>
      </div>
    `;
    return;
  }
  renderChartTabs();
}

function addChartTab(token) {
  if (!token) {
    // Pick top gainer as default
    token = state.tokens.slice().sort((a,b) => b.change - a.change)[0];
  }
  if (!token) return;

  // Don't add duplicate
  const exists = state.chartTabs.find(t => t.id === token.id);
  if (exists) { state.activeChartTab = token.id; renderChartTabs(); return; }

  state.chartTabs.push(token);
  state.activeChartTab = token.id;
  navTo('charts');
  renderChartTabs();
}

function closeChartTab(id, e) {
  if (e) e.stopPropagation();
  state.chartTabs = state.chartTabs.filter(t => t.id !== id);
  if (state.activeChartTab === id) {
    state.activeChartTab = state.chartTabs.length ? state.chartTabs[state.chartTabs.length - 1].id : null;
  }
  renderChartsPage();
}

function renderChartTabs() {
  const inner = document.getElementById('chartsInner');
  if (!inner) return;
  const active = state.chartTabs.find(t => t.id === state.activeChartTab);

  inner.innerHTML = `
    <div class="chart-tabs-bar">
      ${state.chartTabs.map(t => `
        <div class="chart-tab${t.id === state.activeChartTab ? ' active' : ''}" onclick="setActiveChart('${t.id}')">
          ${t.emoji} ${t.symbol}
          <div class="chart-tab-close" onclick="closeChartTab('${t.id}',event)">&#10005;</div>
        </div>
      `).join('')}
      <div class="chart-tab-add" onclick="addChartTab()">+</div>
    </div>
    ${active ? `
    <div class="chart-frame">
      <div class="chart-symbol-bar">
        <div class="chart-sym">${active.emoji} $${active.symbol}</div>
        <div class="chart-price">${fp(active.price)}</div>
        <div class="chart-change ${active.change>=0?'pos':'neg'}">${active.change>=0?'+':''}${active.change.toFixed(2)}%</div>
        <button class="chart-pip-btn" onclick="openPip('${active.id}')">&#9654; PiP</button>
      </div>
      <div class="chart-area">
        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
          ${buildChartSvg(active)}
        </div>
      </div>
      <div class="chart-timeframes">
        ${['1m','5m','15m','1h','4h','1D','1W'].map((tf,i) =>
          `<div class="chart-tf${i===3?' active':''}" onclick="setChartTf(this)">${tf}</div>`
        ).join('')}
      </div>
      <div class="chart-tools">
        <div class="chart-tool-btn">&#128393; Draw</div>
        <div class="chart-tool-btn">&#128200; Indicators</div>
        <div class="chart-tool-btn">&#128247; Snapshot</div>
        <div class="chart-tool-btn">&#128279; Share</div>
      </div>
      <div class="chart-trade-bar">
        <button class="chart-buy">BUY</button>
        <button class="chart-limit">Limit</button>
        <button class="chart-sell">SELL</button>
      </div>
    </div>
    ` : ''}
  `;
}

function buildChartSvg(token) {
  // Generate a representative price chart SVG
  const w = 320, h = 160, pts = 60;
  let v = 80;
  const points = [];
  const up = token.change >= 0;
  for (let i = 0; i < pts; i++) {
    v = Math.max(10, Math.min(150, v + (Math.random() - (up ? 0.42 : 0.58)) * 6));
    points.push({x: (i/(pts-1))*w, y: v});
  }
  const line = points.map((p,i) => (i?'L':'M') + p.x.toFixed(1) + ',' + p.y.toFixed(1)).join('');
  const fill = line + 'L' + w + ',' + h + 'L0,' + h + 'Z';
  const c = up ? '#00e5a0' : '#ff3d6b';
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="width:100%;height:100%;">
    <defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${c}" stop-opacity="0.3"/><stop offset="100%" stop-color="${c}" stop-opacity="0"/></linearGradient></defs>
    <path d="${fill}" fill="url(#cg)"/>
    <path d="${line}" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
}

function setActiveChart(id) {
  state.activeChartTab = id;
  renderChartTabs();
}

function setChartTf(el) {
  el.closest('.chart-timeframes').querySelectorAll('.chart-tf').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

// ------------------------------------------------
// SWAP TAB
// ------------------------------------------------
function renderSwapPage() {
  const el = document.getElementById('swapInner');
  if (!el) return;
  el.innerHTML = `
    <div class="swap-section-title">‚ö° Slippage</div>
    <div class="swap-slippage">
      <div class="slip-opt active" onclick="setSlippage(this,'0.5%')">0.5%</div>
      <div class="slip-opt" onclick="setSlippage(this,'1%')">1%</div>
      <div class="slip-opt" onclick="setSlippage(this,'3%')">3%</div>
      <div class="slip-opt" onclick="setSlippage(this,'5%')">5%</div>
    </div>

    <div class="swap-card">
      <div class="swap-label">You Pay</div>
      <div class="swap-token-row">
        <div class="swap-token-sel">
          <div class="swap-token-ic">‚óé</div>
          <div class="swap-token-sym">SOL</div>
          <div class="swap-token-arr">&#9662;</div>
        </div>
        <input class="swap-amount" id="swapAmtIn" type="number" placeholder="0.00" oninput="updateSwapQuote()">
      </div>
      <div class="swap-usd" id="swapUsdIn">$0.00</div>
    </div>

    <div class="swap-flip" onclick="flipSwap()">&#8693;</div>

    <div class="swap-card">
      <div class="swap-label">You Receive</div>
      <div class="swap-token-row">
        <div class="swap-token-sel" onclick="openSwapTokenPicker()">
          <div class="swap-token-ic" id="swapOutIc">üê∏</div>
          <div class="swap-token-sym" id="swapOutSym">Select</div>
          <div class="swap-token-arr">&#9662;</div>
        </div>
        <input class="swap-amount" id="swapAmtOut" type="number" placeholder="0.00" readonly>
      </div>
      <div class="swap-usd" id="swapUsdOut">$0.00</div>
    </div>

    <div class="swap-info">
      <div class="swap-info-row"><span>Rate</span><span class="swap-info-val" id="swapRate">-</span></div>
      <div class="swap-info-row"><span>Price Impact</span><span class="swap-info-val" id="swapImpact">-</span></div>
      <div class="swap-info-row"><span>Min Received</span><span class="swap-info-val" id="swapMin">-</span></div>
      <div class="swap-info-row"><span>Route</span><span class="swap-info-val">Jupiter</span></div>
    </div>

    <button class="swap-btn" id="swapBtn" onclick="executeSwap()">Connect Wallet to Swap</button>
  `;
}

function setSlippage(el, val) {
  el.closest('.swap-slippage').querySelectorAll('.slip-opt').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
}

function flipSwap() {
  const ic  = document.getElementById('swapOutIc');
  const sym = document.getElementById('swapOutSym');
  const tmp = {ic: ic ? ic.textContent : '‚óé', sym: sym ? sym.textContent : 'SOL'};
  if (ic)  ic.textContent  = '‚óé';
  if (sym) sym.textContent = 'SOL';
  document.getElementById('swapAmtIn').value  = '';
  document.getElementById('swapAmtOut').value = '';
}

function openSwapTokenPicker() {
  if (!state.tokens.length) return;
  const t = state.tokens[Math.floor(Math.random() * Math.min(10, state.tokens.length))];
  const ic  = document.getElementById('swapOutIc');
  const sym = document.getElementById('swapOutSym');
  if (ic)  ic.textContent  = t.emoji;
  if (sym) sym.textContent = t.symbol;
  updateSwapQuote();
}

function updateSwapQuote() {
  const amtIn = parseFloat(document.getElementById('swapAmtIn').value) || 0;
  const solPrice = 150;
  const usdIn = amtIn * solPrice;
  const elUsdIn = document.getElementById('swapUsdIn');
  if (elUsdIn) elUsdIn.textContent = '$' + usdIn.toFixed(2);
  if (amtIn > 0) {
    const impact = (Math.random() * 2).toFixed(2);
    const amtOut = (usdIn / 0.0042 * (1 - parseFloat(impact)/100)).toFixed(0);
    const outEl  = document.getElementById('swapAmtOut');
    if (outEl) outEl.value = amtOut;
    const rateEl = document.getElementById('swapRate'); if (rateEl) rateEl.textContent = '1 SOL = ' + (usdIn/parseFloat(amtOut||1)).toFixed(6);
    const impEl  = document.getElementById('swapImpact'); if (impEl) impEl.textContent = impact + '%';
    const minEl  = document.getElementById('swapMin'); if (minEl) minEl.textContent = (parseFloat(amtOut||0)*0.995).toFixed(0);
  }
}

function executeSwap() { alert('Connect your wallet to swap via Jupiter.'); }

// ------------------------------------------------
// PiP
// ------------------------------------------------
function openPip(id) {
  const t = state.tokens.find(x => x.id === id);
  if (!t) return;
  document.getElementById('pip-s').textContent = t.emoji + ' ' + t.symbol;
  document.getElementById('pip-p').textContent = fp(t.price);
  const ce = document.getElementById('pip-c');
  ce.textContent = (t.change >= 0 ? '+' : '') + t.change.toFixed(2) + '%';
  ce.className = 'pip-c ' + (t.change >= 0 ? 'pos' : 'neg');
  document.getElementById('pip-m').innerHTML = sp(t.change >= 0);
  document.getElementById('pip').classList.add('on');
}
function closePip() { document.getElementById('pip').classList.remove('on'); }

// ------------------------------------------------
// LIVE TICKER
// ------------------------------------------------
function startTicker() {
  const msgs = [
    '<strong>$FROG</strong> just hit 10K holders',
    '<strong>@elonmusk</strong> tweet spawned 3 tokens',
    '<strong>$WIF</strong> whale bought 2.4M',
    '<strong>$BONK</strong> community vote now live',
    '<strong>$PEPE</strong> team posted roadmap update',
  ];
  let i = 0;
  setInterval(() => {
    const el = document.getElementById('ltxt');
    if (!el) return;
    i = (i + 1) % msgs.length;
    el.style.opacity = '0';
    setTimeout(() => { el.innerHTML = msgs[i]; el.style.opacity = '1'; }, 300);
  }, 4000);
  const el = document.getElementById('ltxt');
  if (el) { el.innerHTML = msgs[0]; el.style.opacity = '1'; }
}

// ------------------------------------------------
// NAV CUSTOMIZATION
// ------------------------------------------------
function startLongPress(slot) {
  longPressTimer = setTimeout(() => { if (slot > 0) openNavSheet(slot); }, 600);
}
function endLongPress() { clearTimeout(longPressTimer); }

function enterNavEdit() {
  document.getElementById('navEditBanner').classList.add('visible');
  document.getElementById('bnav').classList.add('edit-mode');
  document.querySelectorAll('.bn').forEach((b, i) => {
    if (i > 0) b.onclick = () => openNavSheet(i);
  });
}

function exitNavEdit() {
  document.getElementById('navEditBanner').classList.remove('visible');
  document.getElementById('bnav').classList.remove('edit-mode');
  buildNav();
}

function openNavSheet(slot) {
  editingNavSlot = slot;
  document.getElementById('slotLabel').textContent = slot + 1;
  const opts = document.getElementById('navOptions');
  opts.innerHTML = ALL_NAV_PAGES.filter(p => !p.locked).map(p => {
    // Disable if already in use (duplicate guard)
    const inUse = state.navSlots.includes(p.id) && state.navSlots.indexOf(p.id) !== slot;
    return `<div class="nav-opt${inUse ? ' in-use' : ''}" onclick="${inUse ? '' : 'assignNavSlot(\'' + p.id + '\')'}">
      <div class="nav-opt-ic">${p.ic}</div>
      <div class="nav-opt-lb">${p.lb}</div>
    </div>`;
  }).join('');
  document.getElementById('navSheet').classList.add('open');
  document.getElementById('sheetOverlay').classList.add('visible');
}

function assignNavSlot(pid) {
  if (editingNavSlot > 0) {
    state.navSlots[editingNavSlot] = pid;
    saveCfg();
    buildNav();
    closeNavSheet();
    exitNavEdit();
  }
}

function closeNavSheet() {
  document.getElementById('navSheet').classList.remove('open');
  // Small delay before removing overlay to prevent accidental taps on iOS
  setTimeout(() => {
    document.getElementById('sheetOverlay').classList.remove('visible');
  }, 100);
}

// ------------------------------------------------
// SETTINGS UI
// ------------------------------------------------
function buildSettingsUI() {
  const tg = document.getElementById('mainThemeGrid');
  tg.innerHTML = THEMES.map(t => `
    <div class="mtheme${(state.cfg.theme||'dark')===t.k?' sel':''}" data-tk="${t.k}" onclick="applyTheme('${t.k}')">
      <div class="mtheme-preview" style="background:linear-gradient(135deg,${t.bg2} 0%,${t.bg4} 100%);"></div>
      <div class="mtheme-name">${t.label}</div>
    </div>
  `).join('');

  const as = document.getElementById('accentSwatches');
  as.innerHTML = ACCENTS.map(a => `
    <div class="swatch${(state.cfg.accent||'#5865f2')===a.h?' selected':''}" data-hex="${a.h}" style="background:${a.h};" title="${a.n}" onclick="applyAccent('${a.h}','${a.g}')"></div>
  `).join('');

  const fg = document.getElementById('fontGrid');
  fg.innerHTML = FONTS.map(f => `
    <div class="font-opt${(state.cfg.font||'modern')===f.k?' sel':''}" data-fk="${f.k}" onclick="applyFont('${f.k}')">
      <div class="font-preview" style="font-family:'${f.ff}',sans-serif;">${f.preview}</div>
      <div class="font-label">${f.label}</div>
    </div>
  `).join('');

  const cp = document.getElementById('customPicker');
  if (cp) cp.addEventListener('input', e => { const hi = document.getElementById('customHex'); if (hi) hi.value = e.target.value; });
}

// ------------------------------------------------
// APPEARANCE
// ------------------------------------------------
function applyTheme(k) {
  THEMES.forEach(t => document.body.classList.remove('theme-' + t.k));
  if (k !== 'dark') document.body.classList.add('theme-' + k);
  state.cfg.theme = k;
  saveCfg();
  document.querySelectorAll('.mtheme').forEach(el => el.classList.toggle('sel', el.dataset.tk === k));
}

function applyFont(k) {
  FONTS.forEach(f => document.body.classList.remove('font-' + f.k));
  if (k !== 'modern') document.body.classList.add('font-' + k);
  state.cfg.font = k;
  saveCfg();
  document.querySelectorAll('.font-opt').forEach(el => el.classList.toggle('sel', el.dataset.fk === k));
}

function h2rgb(hex) {
  return parseInt(hex.slice(1,3),16) + ',' + parseInt(hex.slice(3,5),16) + ',' + parseInt(hex.slice(5,7),16);
}

function lighten(hex, a) {
  a = a === undefined ? 0.18 : a;
  let r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  r = Math.min(255, Math.round(r+(255-r)*a));
  g = Math.min(255, Math.round(g+(255-g)*a));
  b = Math.min(255, Math.round(b+(255-b)*a));
  return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
}

function applyAccent(hex, glow, save) {
  save = save === undefined ? true : save;
  const root = document.documentElement;
  root.style.setProperty('--accent', hex);
  root.style.setProperty('--accent2', lighten(hex));
  root.style.setProperty('--glow', glow || 'rgba(' + h2rgb(hex) + ',0.15)');
  const lbl = document.getElementById('accentLabel'); if (lbl) lbl.textContent = hex;
  const cp  = document.getElementById('customPicker'); if (cp) cp.value = hex;
  const ch  = document.getElementById('customHex'); if (ch) ch.value = hex;
  document.querySelectorAll('.swatch').forEach(s => s.classList.toggle('selected', s.dataset.hex === hex));
  if (save) { state.cfg.accent = hex; state.cfg.accentGlow = glow; saveCfg(); }
}

function applyCustom() {
  let hex = document.getElementById('customHex').value.trim();
  if (!hex.startsWith('#')) hex = '#' + hex;
  if (!/^#[0-9a-fA-F]{6}$/.test(hex)) {
    const i = document.getElementById('customHex');
    i.style.borderColor = 'var(--red)';
    setTimeout(() => { i.style.borderColor = ''; }, 1400);
    return;
  }
  applyAccent(hex, 'rgba(' + h2rgb(hex) + ',0.15)');
}

function restoreAppearance() {
  if (state.cfg.theme)  applyTheme(state.cfg.theme);
  if (state.cfg.font)   applyFont(state.cfg.font);
  if (state.cfg.accent) applyAccent(state.cfg.accent, state.cfg.accentGlow || 'rgba(' + h2rgb(state.cfg.accent) + ',0.15)', false);
}

function togItem(el) {
  const t = el.querySelector('.tog');
  if (!t) return;
  t.classList.toggle('on');
  state.cfg[t.dataset.k] = t.classList.contains('on');
  saveCfg();
}

function applySettingsToggles() {
  document.querySelectorAll('.tog').forEach(t => {
    const k = t.dataset.k;
    if (state.cfg[k] === false) t.classList.remove('on');
    else if (state.cfg[k] === true) t.classList.add('on');
  });
}

// ------------------------------------------------
// SHARE LAYOUT
// ------------------------------------------------
function shareLayout() {
  const layout = {
    tools:  TOOL_CATS.map(c => ({id:c.id, on:c.tools.filter(t=>t.on).map(t=>t.id)})),
    nav:    state.navSlots,
    theme:  state.cfg.theme  || 'dark',
    accent: state.cfg.accent || '#5865f2',
  };
  const url = location.href.split('?')[0] + '?layout=' + btoa(JSON.stringify(layout));
  if (navigator.share)          navigator.share({title:'My Agora Layout', url});
  else if (navigator.clipboard) navigator.clipboard.writeText(url).then(() => alert('Layout link copied!'));
  else                          prompt('Copy your layout link:', url);
}

// ------------------------------------------------
// UTILS
// ------------------------------------------------
function fp(p) {
  if (!p) return '$0';
  if (p < 1e-6)   return '$' + p.toExponential(2);
  if (p < 0.0001) return '$' + p.toFixed(7);
  if (p < 0.01)   return '$' + p.toFixed(5);
  if (p < 1)      return '$' + p.toFixed(4);
  if (p < 10000)  return '$' + p.toFixed(2);
  return '$' + (p/1000).toFixed(1) + 'K';
}

function fn(n) {
  if (!n) return '$0';
  if (n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
  if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K';
  return '$' + n.toFixed(0);
}

function sp(pos) {
  const pts = 14;
  let v = 14;
  const a = [];
  const bias = pos ? 0.38 : 0.62;
  for (let i = 0; i < pts; i++) {
    v = Math.max(3, Math.min(25, v + (Math.random() - bias) * 5));
    a.push({x:(i/(pts-1))*54, y:26-v});
  }
  const d = a.map((p,i) => (i?'L':'M') + p.x.toFixed(1) + ',' + p.y.toFixed(1)).join('');
  const c = pos ? '#00e5a0' : '#ff3d6b';
  return '<svg width="54" height="26" viewBox="0 0 54 26"><path d="' + d + 'L54,26L0,26Z" fill="' + c + '" opacity=".1"/><path d="' + d + '" fill="none" stroke="' + c + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
}

function saveCfg() {
  state.cfg.navSlots = state.navSlots;
  localStorage.setItem('ag4_cfg', JSON.stringify(state.cfg));
}

</script>
</body>
</html>